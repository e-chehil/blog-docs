<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会计分录解析器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            /* 桌面端两栏 */
            gap: 20px;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h2 {
            margin-top: 0;
            color: #333;
        }

        #entryInput {
            width: 100%;
            height: 450px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            line-height: 1.6;
            box-sizing: border-box;
        }

        #journalOutput {
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            border-radius: 6px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            word-break: break-word;
        }

        th {
            background-color: #f7f7f7;
            color: #555;
            font-weight: 600;
            text-align: center;
        }

        .account-debit {
            text-align: left;
            padding-left: 1rem;
        }

        .account-credit {
            text-align: left;
            padding-left: 3rem;
        }

        .amount {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
            font-weight: 600;
            white-space: nowrap;
            /* 保持金额不换行，配合滚动条 */
        }

        /* 移动端特有的金额样式 */
        .amount-debit-mobile {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
            font-weight: 600;
            white-space: nowrap;
            padding-right: 1rem;
        }

        .amount-credit-mobile {
            text-align: right;
            font-family: "Courier New", Courier, monospace;
            font-weight: 600;
            white-space: nowrap;
            padding-left: 2rem;
        }

        /* 移动端隐藏的列 */
        .mobile-hide {
            display: table-cell;
        }

        tfoot {
            border-top: 2px solid #333;
        }

        .total-row td {
            font-weight: bold;
            font-size: 1.05em;
        }

        /* 移动端合计行样式 */
        .total-label-mobile {
            padding-left: 1rem !important;
        }

        .total-debit-mobile {
            text-align: left;
            padding-left: 1.5rem;
            font-size: 0.95em;
        }

        .total-credit-mobile {
            text-align: left;
            padding-left: 1.5rem;
            font-size: 0.95em;
        }

        .balance-row td {
            text-align: center;
            font-weight: bold;
            border-bottom: none;
        }

        .balance-error {
            color: #dc3545;
        }

        .full-comment-row td.full-comment-cell {
            background-color: #f7f7f7;
            color: #444;
            font-weight: 600;
        }

        tr.has-comment>td {
            border-bottom: none;
            padding-bottom: 0;
        }

        .comment-cell {
            padding-top: 4px;
            padding-bottom: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .comment-cell-debit {
            padding-left: 1.5rem;
        }

        .comment-cell-credit {
            padding-left: 3.5rem;
        }

        .amount-formula {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: #007bff;
            color: #007bff;
            /* 默认显示结果时为蓝色 */
        }

        /* 当切换为显示算式时 */
        .amount-formula.showing-formula {
            color: #e83e8c;
            /* 变为粉色 */
            text-decoration-color: #e83e8c;
            font-weight: normal;
        }

        /* --- 响应式设计 --- */
        /* 当屏幕宽度小于或等于 768px 时生效 */
        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }

            #entryInput {
                height: 300px;
            }

            #journalOutput {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* * 【修复2】: 移除 table-layout: fixed;
             * 允许表格自动调整列宽以适应内容，防止溢出
             */
            table {
                width: 100%;
            }

            table thead th:first-child {
                width: 65%;
            }

            table thead th:nth-child(2) {
                width: 35%;
            }

            table thead th:nth-child(3),
            .mobile-hide {
                display: none;
            }

            th,
            td {
                padding: 8px 10px;
            }

            .account-credit {
                padding-left: 2rem;
            }

            .comment-cell-credit {
                padding-left: 2.5rem;
            }

            h2 {
                font-size: 1.25rem;
                margin-bottom: 10px;
            }

            /* 移动端金额列的特殊处理 */
            .amount-debit-mobile {
                padding-right: 2rem;
            }

            .amount-credit-mobile {
                padding-right: 1rem;
            }

            /* 合计行在移动端的特殊样式 */
            .total-row-mobile {
                display: table-row;
            }

            .total-debit-mobile,
            .total-credit-mobile {
                padding-left: 1rem;
            }
        }
    </style>
</head>

<body>
    <div>
        <h2>输入分录</h2>
        <textarea id="entryInput" oninput="parseAndRender()" placeholder="请在此处粘贴分录..."></textarea>
    </div>

    <div>
        <h2>格式化结果</h2>
        <div id="journalOutput">
        </div>
    </div>

    <script>
        // --- 辅助函数 ---
        function formatAmount(amountNum) {
            if (typeof amountNum !== 'number' || isNaN(amountNum)) {
                return {
                    plain: 'N/A',
                    html: 'N/A'
                };
            }

            // 1. 生成标准的、带2位小数的纯文本格式
            const plainFormatted = amountNum.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            let html;

            // 2. 判断是否为整数
            if (Number.isInteger(amountNum)) {
                // 如果是整数，获取不带小数的整数部分
                const integerPart = amountNum.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });

                // 从 plainFormatted 获取小数部分 (例如 ".00")
                const decimalPart = plainFormatted.substring(plainFormatted.lastIndexOf('.'));

                // 生成HTML，将小数部分用 span 包裹并隐藏
                html = `${integerPart}<span class="decimal-part" style="visibility: hidden;">${decimalPart}</span>`;
            } else {
                // 如果是小数，正常显示
                // 我们也用span包裹，以便样式统一（虽然此处非必须）
                const parts = plainFormatted.match(/^(.*?)\.([0-9]{2})$/);
                if (parts) {
                    html = `${parts[1]}<span class="decimal-part">.${parts[2]}</span>`;
                } else {
                    html = plainFormatted; // 备用
                }
            }

            return {
                plain: plainFormatted,
                html: html
            };
        }

        function getLevel1Account(accountPart) {
            const plainTextAccount = accountPart.replace(/<[^>]*>/g, '');
            const match = plainTextAccount.match(/^(.*?)\s*——\s*/);
            return match ? match[1].trim() : plainTextAccount.trim();
        }

        function evaluateAmount(amountStr) {
            let original = amountStr;
            let cleanExpr = amountStr.replace(/,/g, '');
            if (/^(\d+(\.\d*)?|\.\d+)$/.test(cleanExpr)) {
                return {
                    result: parseFloat(cleanExpr),
                    original: original,
                    isFormula: false
                };
            }
            cleanExpr = cleanExpr.replace(/(\d+(\.\d+)?)%/g, '($1/100)').replace(/\^/g, '**');
            const safeMathRegex = /^[\d\s+\-*/().eE]+$/;
            if (!safeMathRegex.test(cleanExpr)) {
                return {
                    result: NaN,
                    original: original,
                    isFormula: false
                };
            }
            try {
                let result = new Function('return ' + cleanExpr)();
                if (typeof result === 'number' && !isNaN(result)) {
                    return {
                        result: result,
                        original: original,
                        isFormula: true
                    };
                }
            } catch (e) { }
            return {
                result: NaN,
                original: original,
                isFormula: false
            };
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // 检测是否为移动设备
        function isMobile() {
            return window.innerWidth <= 768;
        }
        // --- End 辅助函数 ---

        function parseAndRender() {
            const inputText = document.getElementById('entryInput').value;
            const outputDiv = document.getElementById('journalOutput');

            let totalDebit = 0,
                totalCredit = 0;
            const lines = inputText.split('\n');
            let journalEntries = [];
            let currentType = null,
                currentLevel1Account = '';

            for (const rawLine of lines) {
                let parts = rawLine.split('#');
                let processedLine = parts[0].trim();
                let comment = parts.slice(1).join('#').trim() || null;

                if (processedLine === '' && comment) {
                    journalEntries.push({
                        type: 'comment',
                        account: comment
                    });
                    continue;
                } else if (processedLine === '') {
                    continue;
                }

                let entry = {
                    type: null,
                    account: '',
                    comment: comment,
                    originalAmount: '',
                    isFormula: false,
                    amountFormatted: '', // 用于显示的HTML
                    amountPlain: ''      // 用于data-result的纯文本
                };
                let accountPart = '',
                    amountNum = NaN;
                let prefix = '',
                    lineContent = '';

                if (processedLine.startsWith('借：')) {
                    currentType = 'debit';
                    prefix = '借：';
                    lineContent = processedLine.substring(2).trim();
                } else if (processedLine.startsWith('贷：')) {
                    currentType = 'credit';
                    prefix = '贷：';
                    lineContent = processedLine.substring(2).trim();
                } else if (processedLine.startsWith('——')) {
                    prefix = '——';
                    lineContent = processedLine.substring(2).trim();
                } else {
                    prefix = '';
                    lineContent = processedLine.trim();
                }

                if (lineContent === '') {
                    continue;
                }

                // --- 【修复1】: 更新解析逻辑 ---
                let evalResult;
                const contentLastSpace = lineContent.lastIndexOf(' ');

                // 优先尝试解析最后一部分是否为金额
                let potentialAmount = (contentLastSpace === -1) ?
                    lineContent : // 可能是 "1000"
                    lineContent.substring(contentLastSpace + 1).trim(); // 可能是 "Account 1000"

                evalResult = evaluateAmount(potentialAmount);

                if (!isNaN(evalResult.result)) {
                    // 解析成功，是金额
                    amountNum = evalResult.result;
                    // 金额前面的所有内容都是科目
                    accountPart = (contentLastSpace === -1) ?
                        '' : // "1000" 这种情况，科目名为空
                        lineContent.substring(0, contentLastSpace).trim();
                } else {
                    // 解析失败，整行都是科目
                    accountPart = lineContent;
                    amountNum = NaN;
                    evalResult = { original: '', isFormula: false };
                }
                // --- 结束修复1 ---


                if (prefix === '——') {
                    accountPart = `${currentLevel1Account}——${accountPart}`;
                } else {
                    // 仅当科目部分不为空时，才更新一级科目
                    if (accountPart.trim() !== '') {
                        currentLevel1Account = getLevel1Account(accountPart);
                    }
                }

                entry.type = currentType;
                entry.account = accountPart;

                const amountData = isNaN(amountNum) ? { plain: '', html: '' } : formatAmount(amountNum);
                entry.amountFormatted = amountData.html; // 用于显示
                entry.amountPlain = amountData.plain;   // 用于 data-result 属性

                entry.originalAmount = evalResult.original;
                entry.isFormula = evalResult.isFormula;

                if (!isNaN(amountNum)) {
                    if (entry.type === 'debit') totalDebit += amountNum;
                    else if (entry.type === 'credit') totalCredit += amountNum;
                }
                journalEntries.push(entry);
            }

            const epsilon = 0.001;
            const isBalanced = Math.abs(totalDebit - totalCredit) < epsilon;
            renderTable(journalEntries, outputDiv, totalDebit, totalCredit, isBalanced);
        }

        function renderTable(entries, container, totalDebit, totalCredit, isBalanced) {
            if (entries.length === 0) {
                container.innerHTML = '<p style="padding: 15px; color: #888; text-align: center;">暂无内容</p>';
                return;
            }

            const mobile = isMobile();
            let table = '<table>';

            // 表头根据设备类型调整
            if (mobile) {
                table += '<thead><tr><th>账户</th><th>金额</th></tr></thead>';
            } else {
                table += '<thead><tr><th>账户</th><th>借方</th><th>贷方</th></tr></thead>';
            }

            table += '<tbody>';

            for (const entry of entries) {
                if (entry.type === 'comment') {
                    table += `<tr class="full-comment-row"><td colspan="${mobile ? '2' : '3'}" class="full-comment-cell"># ${entry.account}</td></tr>`;
                    continue;
                }

                // 如果类型为null (例如在'借/贷'前输入了纯数字)，则跳过渲染
                // 修复1 允许 accountPart 为空，但 type 必须存在
                if (entry.type === null && entry.account === '' && entry.amountPlain === '') {
                    continue; // 跳过完全无效的行
                }
                // 如果类型为null，但有金额，给予一个默认类型（例如借方）
                // 或者，我们可以要求用户必须先指定 借/贷
                // 当前的逻辑：如果 type 为 null，则不显示
                if (entry.type === null) {
                    continue;
                }


                const hasComment = entry.comment && entry.comment.trim() !== '';
                const escapedFormula = escapeHTML(entry.originalAmount);

                let amountCell = '';
                if (entry.isFormula) {
                    const amountClass = mobile ?
                        (entry.type === 'debit' ? 'amount-debit-mobile' : 'amount-credit-mobile') :
                        'amount';

                    amountCell = `<td class="${amountClass} amount-formula" 
                                        data-formula="${escapedFormula}" 
                                        data-result="${entry.amountPlain}" 
                                        data-state="result" 
                                        title="点击查看算式: ${escapedFormula}">
                                        ${entry.amountFormatted}
                                    </td>`;
                } else {
                    const amountClass = mobile ?
                        (entry.type === 'debit' ? 'amount-debit-mobile' : 'amount-credit-mobile') :
                        'amount';
                    amountCell = `<td class="${amountClass}">${entry.amountFormatted}</td>`;
                }

                table += `<tr class="${hasComment ? 'has-comment' : ''}">`;

                if (mobile) {
                    // 移动端：账户和金额两列
                    if (entry.type === 'debit') {
                        table += `<td class="account-debit">${entry.account}</td>`;
                        table += amountCell;
                    } else if (entry.type === 'credit') {
                        table += `<td class="account-credit">${entry.account}</td>`;
                        table += amountCell;
                    }
                } else {
                    // 桌面端：账户、借方、贷方三列
                    if (entry.type === 'debit') {
                        table += `<td class="account-debit">${entry.account}</td>`;
                        table += amountCell;
                        table += `<td></td>`;
                    } else if (entry.type === 'credit') {
                        table += `<td class="account-credit">${entry.account}</td>`;
                        table += `<td></td>`;
                        table += amountCell;
                    }
                }

                table += '</tr>';

                if (hasComment) {
                    let commentCellClass = entry.type === 'credit' ? 'comment-cell-credit' : 'comment-cell-debit';
                    table += '<tr class="comment-row">';
                    table += `<td colspan="${mobile ? '2' : '3'}" class="comment-cell ${commentCellClass}">↳ ${entry.comment}</td>`;
                    table += '</tr>';
                }
            }
            table += '</tbody>';

            // 合计
            table += '<tfoot>';

            if (mobile) {
                // 移动端：分两行显示借贷合计
                table += '<tr class="total-row">';
                table += `<td colspan="2" class="total-label-mobile"><strong>合计 (Total)</strong></td>`;
                table += '</tr>';
                table += '<tr class="total-row">';
                table += `<td class="total-debit-mobile">借方合计</td>`;
                table += `<td class="amount-debit-mobile">${formatAmount(totalDebit).html}</td>`;
                table += '</tr>';
                table += '<tr class="total-row">';
                table += `<td class="total-credit-mobile">贷方合计</td>`;
                table += `<td class="amount-credit-mobile">${formatAmount(totalCredit).html}</td>`;
                table += '</tr>';
            } else {
                // 桌面端：保持原有的三列显示
                table += '<tr class="total-row">';
                table += `<td><strong>合计 (Total)</strong></td>`;
                table += `<td class="amount">${formatAmount(totalDebit).html}</td>`;
                table += `<td class="amount">${formatAmount(totalCredit).html}</td>`;
                table += '</tr>';
            }

            if (!isBalanced) {
                let difference = Math.abs(totalDebit - totalCredit);
                table += '<tr class="balance-row">';
                table += `<td colspan="${mobile ? '2' : '3'}" class="balance-error">分录未配平 (Unbalanced) - 差额: ${formatAmount(difference).html}</td>`;
                table += '</tr>';
            }
            table += '</tfoot></table>';
            container.innerHTML = table;
        }

        // 监听窗口大小变化，重新渲染
        window.addEventListener('resize', function () {
            parseAndRender();
        });

        // 默认示例
        const defaultEntry = `# 研发部门工资表
借：管理费用——工资（研发部） 5000+0.50
——福利费（研发部） 800+200 # 研发人员福利
贷：应付职工薪酬——工资 5000.50
——福利费 1000 # 贷方注释测试

# 提现 (故意不配平)
借：银行存款 1500 # 从A银行提现
贷：库存现金 1499.99

# 仅有科目的行
贷：库存股（测试）

# 纯数字的行
借：
1000
2000.50
`;

        document.getElementById('entryInput').value = defaultEntry;
        parseAndRender(); // 页面加载时立即解析默认值

        // 重写点击事件，实现原地切换
        document.getElementById('journalOutput').addEventListener('click', function (e) {
            // 检查点击的是否是 .amount-formula 单元格
            const el = e.target;
            if (el && el.classList.contains('amount-formula')) {
                const currentState = el.getAttribute('data-state');
                const formula = el.getAttribute('data-formula');

                if (currentState === 'result') {
                    // 切换为显示算式
                    el.innerHTML = formula;
                    el.setAttribute('data-state', 'formula');
                    const result = el.getAttribute('data-result');
                    el.setAttribute('title', `点击查看结果: ${result}`);
                    el.classList.add('showing-formula');
                } else {
                    // 切换为显示结果
                    const resultStr = el.getAttribute('data-result'); // e.g., "5,000.00"
                    // 将纯文本金额转回数字
                    const resultNum = parseFloat(resultStr.replace(/,/g, ''));
                    // 重新格式化为带隐藏span的HTML
                    el.innerHTML = formatAmount(resultNum).html;
                    el.setAttribute('data-state', 'result');
                    el.setAttribute('title', `点击查看算式: ${formula}`);
                    el.classList.remove('showing-formula');
                }
            }
        });
    </script>
</body>

</html>