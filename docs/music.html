<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“è¾‘æµ·æŠ¥è®¾è®¡ (ç§æœ‰ä»£ç†ç»ˆæç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/488/main/result.css">
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/7/main/result.css">

    <style>
        body {
            font-family: "STDongGuanTi", 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .light-panel {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .template-selector input[type="radio"] {
            display: none;
        }

        .template-selector label {
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 8px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .template-selector input[type="radio"]:checked+label {
            background-color: #C81E1E;
            color: #FFFFFF;
            border-color: #EF4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .template-selector label:hover {
            background-color: #f3f4f6;
        }

        .light-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111827;
            border-radius: 0.375rem;
        }

        .light-input:focus {
            outline: none;
            border-color: #EF4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }

        .light-slot {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            color: #9ca3af;
            transition: all 0.2s ease-in-out;
        }

        .light-slot:hover {
            border-color: #EF4444;
            color: #ef4444;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        /* è°ƒè¯•æ—¥å¿—æ ·å¼ */
        #debug-panel {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            background: #18181b;
            color: #4ade80;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 240px;
            overflow-y: auto;
            display: none;
            border: 1px solid #333;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .log-entry {
            margin-bottom: 6px;
            border-bottom: 1px solid #27272a;
            padding-bottom: 2px;
            word-break: break-all;
        }

        .log-error {
            color: #f87171;
        }

        .log-warn {
            color: #facc15;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-success {
            color: #4ade80;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- æ ‡é¢˜ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold" style="font-family: 'STDongGuanTi', serif; color: #C81E1E;">
                ä¸“è¾‘æµ·æŠ¥è®¾è®¡
            </h1>
            <p class="text-gray-600 mt-2" style="font-family: 'Zhuque Fangsong (technical preview)', sans-serif;">
                ä¸“ç”¨ä»£ç†æé€Ÿç‰ˆ Â· æ”¯æŒçŸ­é“¾æ¥
            </p>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex flex-col md:flex-row gap-6 md:gap-8">

            <!-- ç”»å¸ƒé¢„è§ˆ -->
            <section class="w-full md:w-2/3 lg:w-2/3">
                <div class="w-full light-panel p-2 sticky top-8">
                    <canvas id="poster-canvas" width="3000" height="3000"
                        class="w-full h-auto rounded-lg aspect-square"></canvas>
                </div>

                <div class="mt-4 text-right">
                    <button id="toggle-debug"
                        class="text-xs text-gray-500 underline hover:text-red-500">å¦‚æœä¸å·¥ä½œï¼Œç‚¹æ­¤æŸ¥çœ‹æ—¥å¿—</button>
                </div>
                <div id="debug-panel"></div>
            </section>

            <!-- æ§åˆ¶é¢æ¿ -->
            <aside class="w-full md:w-1/3 lg:w-1/3 shrink-0">
                <div class="light-panel p-5 md:p-6 flex flex-col gap-6">

                    <!-- 1. æµ·æŠ¥æ–‡æœ¬ -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">1. æµ·æŠ¥æ–‡æœ¬</h2>
                        <div>
                            <label for="poster-title" class="text-sm font-medium text-gray-700 mb-1 block">æ ‡é¢˜</label>
                            <input type="text" id="poster-title" placeholder="é¡”è‰²æ¨æ­Œ"
                                class="w-full h-10 px-3 light-input">
                        </div>
                        <div>
                            <label for="poster-sharer" class="text-sm font-medium text-gray-700 mb-1 block">åˆ†äº«äºº</label>
                            <input type="text" id="poster-sharer" placeholder="å¡«è¡¨äººï¼š"
                                class="w-full h-10 px-3 light-input">
                        </div>
                    </div>

                    <!-- 2. é€‰æ‹©å¸ƒå±€ -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">2. é€‰æ‹©å¸ƒå±€</h2>
                        <div class="grid grid-cols-3 gap-3 template-selector">
                            <div>
                                <input type="radio" name="template" id="template-hero" value="hero">
                                <label for="template-hero">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M4 4H14V14H4V4ZM16 4H20V8H16V4ZM16 10H20V14H16V10Z" />
                                    </svg>
                                    ç²¾é€‰ (3å›¾)
                                </label>
                            </div>
                            <div>
                                <input type="radio" name="template" id="template-grid-2x2" value="grid-2x2">
                                <label for="template-grid-2x2">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M4 4H10V10H4V4ZM14 4H20V10H14V4ZM4 14H10V20H4V14ZM14 14H20V20H14V14Z" />
                                    </svg>
                                    ç½‘æ ¼ (4å›¾)
                                </label>
                            </div>
                            <div>
                                <input type="radio" name="template" id="template-grid-3x3" value="grid-3x3" checked>
                                <label for="template-grid-3x3">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M4 4H8V8H4V4ZM10 4H14V8H10V4ZM16 4H20V8H16V4ZM4 10H8V14H4V10ZM10 10H14V14H10V10ZM16 10H20V14H16V10ZM4 16H8V20H4V16ZM10 16H14V20H10V16ZM16 16H20V20H16V16Z" />
                                    </svg>
                                    ä¹å®« (9å›¾)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3. ä¸Šä¼  / æå–å°é¢ -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">3. ä¸Šä¼  / æå–å°é¢
                        </h2>
                        <div class="flex flex-col gap-3 mb-5 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <label for="netease-url-input" class="text-sm font-medium text-gray-700">ç½‘æ˜“äº‘é“¾æ¥ / çŸ­é“¾æ¥</label>
                            <input type="text" id="netease-url-input" placeholder="ç²˜è´´åˆ†äº«æ–‡æœ¬ï¼Œæ”¯æŒçŸ­é“¾..."
                                class="w-full h-10 px-3 light-input">
                            <div class="flex gap-2">
                                <select id="netease-slot-select"
                                    class="flex-grow h-10 px-3 light-input text-sm focus:ring-0">
                                    <!-- Options generated via JS -->
                                </select>
                                <button id="netease-fetch-btn"
                                    class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-md text-sm whitespace-nowrap flex items-center justify-center disabled:bg-gray-400"
                                    style="min-width: 80px;">
                                    <span id="netease-btn-text">æå–</span>
                                    <div id="netease-loader" class="loader hidden"></div>
                                </button>
                            </div>
                            <div id="netease-msg" class="text-xs text-center hidden"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-3" id="slots-grid">
                            <!-- Slots 1-9 will be generated by JS to keep HTML clean -->
                        </div>
                    </div>

                    <!-- 4. æ ·å¼å’Œæ“ä½œ -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">4. æ ·å¼ä¸æ“ä½œ</h2>
                        <div class="flex flex-col">
                            <label for="bg-color" class="text-sm font-medium text-gray-700 mb-2">æµ·æŠ¥èƒŒæ™¯è‰²</label>
                            <input id="bg-color" type="color" value="#F4F4F8"
                                class="w-full h-10 p-1 rounded-md light-input cursor-pointer appearance-none border-gray-300">
                        </div>
                        <div class="flex flex-col">
                            <label for="poster-padding" class="text-sm font-medium text-gray-700 mb-2">æµ·æŠ¥å†…è¾¹è·: <span
                                    id="padding-value">180</span>px</label>
                            <input id="poster-padding" type="range" value="180" min="60" max="450" class="w-full">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <button id="clear-btn"
                                class="w-full py-3 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition-colors shadow-md">
                                æ¸…ç©º
                            </button>
                            <button id="download-btn"
                                class="w-full py-3 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-lg shadow-red-600/30">
                                ä¸‹è½½æµ·æŠ¥
                            </button>
                        </div>
                    </div>

                </div>
            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- å…¨å±€é…ç½® ---
            const CANVAS_SIZE = 3000;

            // âš ï¸ è¿™é‡ŒæŠŠä½ çš„ç§æœ‰ä»£ç†æ”¾åœ¨æœ€å‰é¢ï¼Œä¼˜å…ˆçº§æœ€é«˜
            const CORS_PROXIES = [
                "https://music-api.chehil.icu/?url=",
                // ç§»é™¤ workers.devï¼Œå› ä¸ºå®ƒåœ¨å›½å†…ç§»åŠ¨ç½‘ç»œä¸‹é€šå¸¸æ˜¯æ­»è·¯ï¼Œä¼šæµªè´¹è¶…æ—¶æ—¶é—´
                // "https://netease-proxy.echehil.workers.dev/?url=", 
                "https://api.allorigins.win/raw?url=", // è¿™ä¸ªç›®å‰çœ‹èµ·æ¥æœ€ç¨³ï¼Œæ”¾ç¬¬äºŒä¸ª
                "https://corsproxy.io/?", // å¤‡ç”¨
                "https://api.codetabs.com/v1/proxy?quest=" // å¤‡ç”¨
            ];

            // çŠ¶æ€
            let sourceUrls = {};
            let loadedImages = {};
            let noisePatternCanvas = null;

            // DOM
            const canvas = document.getElementById('poster-canvas');
            const ctx = canvas.getContext('2d');
            const debugPanel = document.getElementById('debug-panel');
            const toggleDebugBtn = document.getElementById('toggle-debug');

            // --- åˆå§‹åŒ– DOM ---
            initSlots();
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // --- æ—¥å¿—å·¥å…· ---
            function log(msg, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${msg}`);
                const div = document.createElement('div');
                div.className = `log-entry log-${type}`;
                div.textContent = `> ${msg}`;
                debugPanel.appendChild(div);
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }

            toggleDebugBtn.addEventListener('click', () => {
                debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
            });

            // --- æ ¸å¿ƒä»£ç†è¯·æ±‚å‡½æ•° ---
            async function fetchViaProxy(targetUrl) {
                let errors = [];
                log(`å¼€å§‹è¯·æ±‚: ${targetUrl}`);

                for (const proxyBase of CORS_PROXIES) {
                    const proxyUrl = `${proxyBase}${encodeURIComponent(targetUrl)}`;
                    log(`å°è¯•ä»£ç†: ${proxyBase}`, 'info');

                    try {
                        const controller = new AbortController();
                        // ä¿®æ”¹ï¼šå°†è¶…æ—¶æ—¶é—´ä» 10000 æ”¹ä¸º 25000 (25ç§’)
                        // ç§»åŠ¨ç½‘ç»œæ³¢åŠ¨å¤§ï¼Œç»™ Cloudflare Worker æ›´å¤šæ—¶é—´å»æŠ“å–æ•°æ®
                        const id = setTimeout(() => controller.abort(), 25000);

                        const resp = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(id);

                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                        const text = await resp.text();
                        if (text.length < 50) throw new Error("å“åº”å†…å®¹ä¸ºç©ºæˆ–è¿‡çŸ­");

                        log(`ä»£ç†æˆåŠŸ! æ”¶åˆ° ${text.length} å­—èŠ‚`, 'success');
                        return text;
                    } catch (e) {
                        // ä¼˜åŒ–é”™è¯¯æ—¥å¿—æ˜¾ç¤º
                        const errMsg = e.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶ (è¶…è¿‡25ç§’)' : e.message;
                        log(`ä»£ç†å¤±è´¥ (${proxyBase}): ${errMsg}`, 'warn');
                        errors.push(errMsg);
                    }
                }
                throw new Error(`æ‰€æœ‰ä»£ç†å‡å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚`);
            }

            // --- æå–é€»è¾‘ (é€‚é…ä½ çš„ Worker) ---
            async function handleExtract() {
                const input = document.getElementById('netease-url-input');
                const slotSelect = document.getElementById('netease-slot-select');
                const btn = document.getElementById('netease-fetch-btn');
                const loader = document.getElementById('netease-loader');
                const btnText = document.getElementById('netease-btn-text');
                const msgBox = document.getElementById('netease-msg');

                const rawText = input.value.trim();
                if (!rawText) return alert('è¯·è¾“å…¥é“¾æ¥');

                // UI Loading
                btn.disabled = true;
                loader.classList.remove('hidden');
                btnText.classList.add('hidden');
                msgBox.classList.add('hidden');
                debugPanel.innerHTML = ''; // æ¸…ç©ºæ—§æ—¥å¿—

                try {
                    // 1. æå– URL
                    const urlMatch = rawText.match(/(https?:\/\/[^\s"'()]+)/);
                    if (!urlMatch) throw new Error("æœªæ‰¾åˆ°é“¾æ¥");
                    let targetUrl = urlMatch[0].replace(/\/$/, ""); // å»é™¤æœ«å°¾æ–œæ 

                    // 2. æ™ºèƒ½å¤„ç† (çŸ­é“¾/é‡å®šå‘/HTMLè§£æ)
                    // ä½ çš„ Worker é…ç½®äº† redirect: followï¼Œæ‰€ä»¥å®ƒä¼šè¿”å›æœ€ç»ˆé¡µé¢çš„ HTML
                    // æˆ‘ä»¬ä¸»è¦ä¾èµ– Worker çš„èƒ½åŠ›
                    const htmlContent = await fetchViaProxy(targetUrl);

                    let realId = null;
                    let realType = null;
                    let imageUrl = null;

                    // --- æ­¥éª¤ A: å°è¯•ä» Worker çš„è‡ªå®šä¹‰æ³¨é‡Šä¸­è¯»å– (å¦‚æœä½ æ”¹äº† Worker) ---
                    const workerMarkerMatch = htmlContent.match(/<!-- REAL_URL: (.*?) -->/);
                    if (workerMarkerMatch) {
                        const realUrl = workerMarkerMatch[1];
                        log(`Worker è¿”å›äº†çœŸå®åœ°å€: ${realUrl}`, 'success');
                        // ä»çœŸå®åœ°å€æå– ID
                        const idMatch = realUrl.match(/(song|album|playlist)(?:\/|\?id=)(\d+)/);
                        if (idMatch) {
                            realType = idMatch[1];
                            realId = idMatch[2];
                        }
                    }

                    // --- æ­¥éª¤ B: å¦‚æœæ²¡æ”¹ Workerï¼Œå°è¯•ä» HTML meta æ ‡ç­¾ä¸­â€œå€’æ¨â€çœŸå®åœ°å€ ---
                    if (!realId) {
                        log('å°è¯•ä» HTML Meta æ ‡ç­¾è§£æ ID...', 'info');
                        // æŸ¥æ‰¾ og:url æˆ– canonical
                        // ç½‘æ˜“äº‘é€šå¸¸æœ‰ <meta property="og:url" content="https://music.163.com/song?id=..." />
                        const metaMatch = htmlContent.match(/property="og:url"\s+content="([^"]+)"/) ||
                            htmlContent.match(/link\s+rel="canonical"\s+href="([^"]+)"/);

                        if (metaMatch) {
                            const metaUrl = metaMatch[1];
                            log(`åœ¨ HTML ä¸­å‘ç° URL: ${metaUrl}`, 'success');
                            const idMatch = metaUrl.match(/(song|album|playlist)(?:\/|\?id=)(\d+)/);
                            if (idMatch) {
                                realType = idMatch[1];
                                realId = idMatch[2];
                            }
                        } else {
                            // æœ€åçš„æŒ£æ‰ï¼šåœ¨æ•´ä¸ª HTML æ–‡æœ¬ä¸­æœç´¢ "song?id=xxxx" æ¨¡å¼
                            // è¿™å¯¹äºçŸ­é“¾æ¥è·³è½¬åçš„é¡µé¢éå¸¸æœ‰æ•ˆ
                            const bruteForceMatch = htmlContent.match(/(song|album|playlist)\?id=(\d+)/);
                            if (bruteForceMatch) {
                                log(`æš´åŠ›æœç´¢å‘ç° ID: ${bruteForceMatch[1]}/${bruteForceMatch[2]}`, 'success');
                                realType = bruteForceMatch[1];
                                realId = bruteForceMatch[2];
                            }
                        }
                    }

                    // --- æ­¥éª¤ C: å¦‚æœæ‰¾åˆ°äº† IDï¼Œä½¿ç”¨ API è·å–é«˜æ¸…å›¾ (API æ˜¯æœ€æ¸…æ™°çš„) ---
                    if (realId && realType) {
                        log(`IDå·²ç¡®è®¤ (${realType}: ${realId})ï¼Œæ­£åœ¨è¯·æ±‚ API...`, 'info');
                        try {
                            let apiUrl = "";
                            if (realType === 'song') apiUrl = `https://music.163.com/api/song/detail?ids=[${realId}]`;
                            else if (realType === 'album') apiUrl = `https://music.163.com/api/album/${realId}`;
                            else if (realType === 'playlist') apiUrl = `https://music.163.com/api/playlist/detail?id=${realId}`;

                            if (apiUrl) {
                                // è·å– API è¿”å›çš„æ–‡æœ¬
                                let apiJsonText = await fetchViaProxy(apiUrl);

                                // ğŸŒŸ å…³é”®ä¿®å¤ï¼šæ¸…ç† Worker æ·»åŠ çš„æ³¨é‡Š
                                // ä½ çš„ Worker ä¼šåœ¨æ‰€æœ‰è¿”å›å†…å®¹ååŠ ä¸Š "\n<!-- REAL_URL: ... -->"
                                // è¿™ä¼šè®© JSON.parse å´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è§£æå‰æŠŠå®ƒåˆ æ‰
                                apiJsonText = apiJsonText.replace(/<!-- REAL_URL:[\s\S]*?-->/g, '').trim();

                                const data = JSON.parse(apiJsonText);

                                if (realType === 'song' && data.songs?.[0]?.album?.picUrl) {
                                    imageUrl = data.songs[0].album.picUrl;
                                } else if (realType === 'album' && data.album?.picUrl) {
                                    imageUrl = data.album.picUrl;
                                } else if (realType === 'playlist' && data.result?.coverImgUrl) {
                                    imageUrl = data.result.coverImgUrl;
                                }
                                log('API JSON è§£ææˆåŠŸï¼', 'success');
                            }
                        } catch (apiErr) {
                            log(`APIè¯·æ±‚å¤±è´¥ (${apiErr.message})ï¼Œå›é€€åˆ° HTML è§£æ`, 'warn');
                        }
                    }

                    // --- æ­¥éª¤ D: å¦‚æœ API å¤±è´¥ï¼Œç›´æ¥ç”¨ og:image ---
                    if (!imageUrl) {
                        log('API å¤±è´¥æˆ– ID æœªçŸ¥ï¼Œå°è¯•æå– og:image...', 'info');
                        const imgMatch = htmlContent.match(/property="og:image"\s+content="([^"]+)"/);
                        if (imgMatch) {
                            imageUrl = imgMatch[1];
                        } else {
                            // æš´åŠ›åŒ¹é…å›¾ç‰‡
                            const jpgRegex = /(https?:\/\/[p-z]\d?\.music\.126\.net\/[^"'\s)]+)/i;
                            const m = htmlContent.match(jpgRegex);
                            if (m) imageUrl = m[0];
                        }
                    }

                    if (!imageUrl) throw new Error("æ— æ³•æå–å°é¢ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ");

                    // æˆåŠŸï¼
                    const hdUrl = imageUrl.split('?')[0] + '?param=3000y3000';
                    const slot = slotSelect.value;

                    log(`æˆåŠŸæå–å°é¢: ${hdUrl}`, 'success');

                    await updateSlotImage(slot, hdUrl);
                    input.value = '';

                    // è‡ªåŠ¨åˆ‡åˆ°ä¸‹ä¸€ä¸ª
                    let next = parseInt(slot) + 1;
                    if (next > 9) next = 1;
                    slotSelect.value = next;

                    msgBox.textContent = "æå–æˆåŠŸï¼";
                    msgBox.className = "text-xs text-center mt-1 block text-green-600";
                    msgBox.classList.remove('hidden');

                } catch (err) {
                    log(`æµç¨‹ç»ˆæ­¢: ${err.message}`, 'error');
                    msgBox.textContent = "æå–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—";
                    msgBox.className = "text-xs text-center mt-1 block text-red-500";
                    msgBox.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    loader.classList.add('hidden');
                    btnText.classList.remove('hidden');
                }
            }

            // --- æ ¸å¿ƒç»˜å›¾ä¸äº¤äº’ ---

            function initSlots() {
                const grid = document.getElementById('slots-grid');
                const select = document.getElementById('netease-slot-select');

                for (let i = 1; i <= 9; i++) {
                    // ç”Ÿæˆä¸‹æ‹‰èœå•
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `åˆ°æ’æ§½ ${i}`;
                    select.appendChild(opt);

                    // ç”Ÿæˆä¹å®«æ ¼UI
                    const div = document.createElement('div');
                    div.className = "relative aspect-square light-slot rounded-lg flex items-center justify-center text-center overflow-hidden group";
                    div.innerHTML = `
                        <img id="preview-${i}" class="absolute inset-0 w-full h-full object-cover z-10 hidden">
                        <div class="z-0 text-xs text-gray-400 pointer-events-none">æ’æ§½ ${i}</div>
                        <button onclick="clearSlot(${i})" id="del-${i}" class="absolute top-1 right-1 w-6 h-6 bg-black/50 hover:bg-red-600 text-white rounded-full z-20 hidden items-center justify-center transition-colors">&times;</button>
                        <input type="file" accept="image/*" data-slot="${i}" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFile(this)">
                    `;
                    grid.appendChild(div);
                }
            }

            window.handleFile = function (input) {
                const slot = input.dataset.slot;
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => updateSlotImage(slot, e.target.result, false); // false = ä¸å­˜URLçŠ¶æ€
                reader.readAsDataURL(file);
            }

            window.clearSlot = function (slot) {
                delete sourceUrls[slot];
                delete loadedImages[slot];
                document.getElementById(`preview-${slot}`).classList.add('hidden');
                document.getElementById(`del-${slot}`).classList.add('hidden');
                document.querySelector(`input[data-slot="${slot}"]`).value = '';
                draw();
                updateUrlState();
            }

            async function updateSlotImage(slot, url, saveState = true) {
                if (saveState) sourceUrls[slot] = url;

                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        loadedImages[slot] = img;
                        document.getElementById(`preview-${slot}`).src = url;
                        document.getElementById(`preview-${slot}`).classList.remove('hidden');
                        document.getElementById(`del-${slot}`).classList.remove('hidden');
                        draw();
                        if (saveState) updateUrlState();
                        resolve();
                    };
                    img.onerror = () => {
                        log(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${url}`, 'error');
                        reject();
                    };
                    img.src = url;
                });
            }

            function draw() {
                // åŸºç¡€è®¾ç½®
                const bgColor = document.getElementById('bg-color').value;
                const padding = parseInt(document.getElementById('poster-padding').value);
                const title = document.getElementById('poster-title').value || "é¡”è‰²æ¨æ­Œ";
                const sharer = document.getElementById('poster-sharer').value || "å¡«è¡¨äººï¼š";
                const layout = document.querySelector('input[name="template"]:checked').value;

                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // å™ªç‚¹
                if (!noisePatternCanvas) noisePatternCanvas = createNoise();
                ctx.save();
                ctx.globalCompositeOperation = 'overlay';
                ctx.globalAlpha = 0.15;
                ctx.fillStyle = ctx.createPattern(noisePatternCanvas, 'repeat');
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                ctx.restore();

                // é¢œè‰²ç­–ç•¥
                const isDark = getLuminance(bgColor) < 128;
                const textColor = isDark ? '#F9FAFB' : '#111827';
                const subColor = isDark ? '#D1D5DB' : '#4B5563';

                // å¸ƒå±€åŒºåŸŸ
                const topH = 450;
                const botH = 300;
                const area = {
                    x: padding,
                    y: padding + topH,
                    w: CANVAS_SIZE - padding * 2,
                    h: CANVAS_SIZE - padding * 2 - topH - botH
                };

                // å›¾ç‰‡åˆ—è¡¨
                const imgs = [];
                for (let i = 1; i <= 9; i++) if (loadedImages[i]) imgs.push(loadedImages[i]);

                // ç»˜åˆ¶å›¾ç‰‡
                if (imgs.length > 0) {
                    if (layout === 'hero') drawHero(imgs, area);
                    else if (layout === 'grid-2x2') drawGrid(imgs, area, 2);
                    else drawGrid(imgs, area, 3);
                } else {
                    ctx.fillStyle = subColor;
                    ctx.font = '90px "STDongGuanTi"';
                    ctx.textAlign = 'center';
                    ctx.fillText('è¯·æ·»åŠ å°é¢', CANVAS_SIZE / 2, CANVAS_SIZE / 2);
                }

                // ç»˜åˆ¶æ–‡å­—
                ctx.textAlign = 'center';
                ctx.fillStyle = textColor;
                ctx.font = 'bold 156px "STDongGuanTi"';
                ctx.fillText(title, CANVAS_SIZE / 2, padding + topH / 2 + 50);

                ctx.fillStyle = subColor;
                ctx.font = 'normal 84px "Zhuque Fangsong (technical preview)"';
                ctx.fillText(sharer, CANVAS_SIZE / 2, CANVAS_SIZE - padding - botH / 2 + 40);
            }

            // å¸ƒå±€ç®—æ³•
            function drawHero(imgs, rect) {
                if (!imgs[0]) return;
                const gap = 60;
                const mainS = rect.h;
                const subS = (rect.h - gap) / 2;
                const totalW = mainS + gap + subS;
                const startX = rect.x + (rect.w - totalW) / 2;

                drawImg(imgs[0], startX, rect.y, mainS);
                if (imgs[1]) drawImg(imgs[1], startX + mainS + gap, rect.y, subS);
                if (imgs[2]) drawImg(imgs[2], startX + mainS + gap, rect.y + subS + gap, subS);
            }

            function drawGrid(imgs, rect, cols) {
                const gap = 60;
                let size = (rect.w - (cols - 1) * gap) / cols;
                // é«˜åº¦çº¦æŸ
                if (size * cols + (cols - 1) * gap > rect.h) {
                    size = (rect.h - (cols - 1) * gap) / cols;
                }
                const totalSize = size * cols + (cols - 1) * gap;
                const sx = rect.x + (rect.w - totalSize) / 2;
                const sy = rect.y + (rect.h - totalSize) / 2;

                const limit = cols * cols;
                for (let i = 0; i < Math.min(imgs.length, limit); i++) {
                    const r = Math.floor(i / cols);
                    const c = i % cols;
                    drawImg(imgs[i], sx + c * (size + gap), sy + r * (size + gap), size);
                }
            }

            function drawImg(img, x, y, s) {
                const r = 24;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x + r, y); ctx.lineTo(x + s - r, y); ctx.quadraticCurveTo(x + s, y, x + s, y + r);
                ctx.lineTo(x + s, y + s - r); ctx.quadraticCurveTo(x + s, y + s, x + s - r, y + s);
                ctx.lineTo(x + r, y + s); ctx.quadraticCurveTo(x, y + s, x, y + s - r);
                ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
                ctx.clip();

                const min = Math.min(img.width, img.height);
                ctx.drawImage(img, (img.width - min) / 2, (img.height - min) / 2, min, min, x, y, s, s);
                ctx.restore();
            }

            // å·¥å…·å‡½æ•°
            function createNoise() {
                const c = document.createElement('canvas');
                c.width = 200; c.height = 200;
                const cx = c.getContext('2d');
                const d = cx.createImageData(200, 200);
                for (let i = 0; i < d.data.length; i += 4) {
                    const v = Math.random() * 255;
                    d.data[i] = d.data[i + 1] = d.data[i + 2] = v;
                    d.data[i + 3] = 255;
                }
                cx.putImageData(d, 0, 0);
                return c;
            }

            function getLuminance(hex) {
                const r = parseInt(hex.substr(1, 2), 16);
                const g = parseInt(hex.substr(3, 2), 16);
                const b = parseInt(hex.substr(5, 2), 16);
                return (r * 299 + g * 587 + b * 114) / 1000;
            }

            // URL State ç®¡ç†
            function updateUrlState() {
                const state = {
                    t: document.getElementById('poster-title').value,
                    s: document.getElementById('poster-sharer').value,
                    bg: document.getElementById('bg-color').value,
                    p: document.getElementById('poster-padding').value,
                    l: document.querySelector('input[name="template"]:checked').value,
                    i: sourceUrls
                };
                const str = btoa(encodeURIComponent(JSON.stringify(state)));
                window.history.replaceState({}, '', `?d=${str}`);
            }

            function loadUrlState() {
                const p = new URLSearchParams(window.location.search);
                if (!p.get('d')) { draw(); return; }
                try {
                    const s = JSON.parse(decodeURIComponent(atob(p.get('d'))));
                    if (s.t) document.getElementById('poster-title').value = s.t;
                    if (s.s) document.getElementById('poster-sharer').value = s.s;
                    if (s.bg) document.getElementById('bg-color').value = s.bg;
                    if (s.p) document.getElementById('poster-padding').value = s.p;
                    if (s.l) document.getElementById(`template-${s.l}`).checked = true;

                    if (s.i) {
                        for (let k in s.i) {
                            if (s.i[k]) updateSlotImage(k, s.i[k], true);
                        }
                    } else {
                        draw();
                    }
                } catch (e) { console.error(e); draw(); }
            }

            // Bindings
            document.getElementById('netease-fetch-btn').onclick = handleExtract;
            document.getElementById('clear-btn').onclick = () => {
                sourceUrls = {}; loadedImages = {};
                initSlots(); // rebuild slots
                draw();
                updateUrlState();
            };
            document.getElementById('download-btn').onclick = () => {
                const a = document.createElement('a');
                a.download = `poster-${Date.now()}.png`;
                a.href = canvas.toDataURL();
                a.click();
            };
            ['poster-title', 'poster-sharer', 'bg-color', 'poster-padding'].forEach(id => {
                document.getElementById(id).oninput = () => { draw(); updateUrlState(); };
            });
            document.querySelectorAll('input[name="template"]').forEach(el => {
                el.onchange = () => { draw(); updateUrlState(); };
            });

            loadUrlState();
        });
    </script>
</body>

</html>