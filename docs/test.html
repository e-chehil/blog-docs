<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专辑海报设计 (链接分享状态)</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 引入自定义字体 (STDongGuanTi 和 Zhuque Fangsong) -->
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/488/main/result.css">
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/7/main/result.css">

    <style>
        /* 全局应用新字体 */
        body {
            font-family: "STDongGuanTi", 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .light-panel {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .template-selector input[type="radio"] {
            display: none;
        }

        .template-selector label {
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 8px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .template-selector input[type="radio"]:checked+label {
            background-color: #C81E1E;
            color: #FFFFFF;
            border-color: #EF4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .template-selector label:hover {
            background-color: #f3f4f6;
        }

        .light-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111827;
            border-radius: 0.375rem;
        }

        .light-input:focus {
            outline: none;
            border-color: #EF4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }

        .light-slot {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            color: #9ca3af;
            transition: all 0.2s ease-in-out;
        }

        .light-slot:hover {
            border-color: #EF4444;
            color: #ef4444;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 标题 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold" style="font-family: 'STDongGuanTi', serif; color: #C81E1E;">
                专辑海报设计
            </h1>
            <p class="text-gray-600 mt-2" style="font-family: 'Zhuque Fangsong (technical preview)', sans-serif;">
                链接分享 · 3000px 高清画布
            </p>
        </header>

        <!-- 主内容区 -->
        <main class="flex flex-col md:flex-row gap-6 md:gap-8">

            <!-- 画布预览 -->
            <section class="w-full md:w-2/3 lg:w-2/3">
                <div class="w-full light-panel p-2 sticky top-8">
                    <canvas id="poster-canvas" width="3000" height="3000"
                        class="w-full h-auto rounded-lg aspect-square"></canvas>
                </div>
            </section>

            <!-- 控制面板 -->
            <aside class="w-full md:w-1/3 lg:w-1/3 shrink-0">
                <div class="light-panel p-5 md:p-6 flex flex-col gap-6">

                    <!-- 1. 海报文本 -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">1. 海报文本</h2>
                        <div>
                            <label for="poster-title" class="text-sm font-medium text-gray-700 mb-1 block">标题</label>
                            <input type="text" id="poster-title" placeholder="顔色推歌"
                                class="w-full h-10 px-3 light-input">
                        </div>
                        <div>
                            <label for="poster-sharer" class="text-sm font-medium text-gray-700 mb-1 block">分享人</label>
                            <input type="text" id="poster-sharer" placeholder="填表人："
                                class="w-full h-10 px-3 light-input">
                        </div>
                    </div>

                    <!-- 2. 选择布局 -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">2. 选择布局</h2>
                        <div class="grid grid-cols-3 gap-3 template-selector">
                            <!-- 模板: Hero (3) -->
                            <div>
                                <input type="radio" name="template" id="template-hero" value="hero">
                                <label for="template-hero">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 4H14V14H4V4ZM16 4H20V8H16V4ZM16 10H20V14H16V10Z" />
                                    </svg>
                                    精选 (3图)
                                </label>
                            </div>
                            <!-- 模板: Grid (4) -->
                            <div>
                                <input type="radio" name="template" id="template-grid-2x2" value="grid-2x2">
                                <label for="template-grid-2x2">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M4 4H10V10H4V4ZM14 4H20V10H14V4ZM4 14H10V20H4V14ZM14 14H20V20H14V14Z" />
                                    </svg>
                                    网格 (4图)
                                </label>
                            </div>
                            <!-- 模板: Grid (9) -->
                            <div>
                                <input type="radio" name="template" id="template-grid-3x3" value="grid-3x3" checked>
                                <label for="template-grid-3x3">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M4 4H8V8H4V4ZM10 4H14V8H10V4ZM16 4H20V8H16V4ZM4 10H8V14H4V10ZM10 10H14V14H10V10ZM16 10H20V14H16V10ZM4 16H8V20H4V16ZM10 16H14V20H10V16ZM16 16H20V20H16V16Z" />
                                    </svg>
                                    九宫 (9图)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 上传 / 提取封面 -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">3. 上传 / 提取封面
                        </h2>
                        <div class="flex flex-col gap-3 mb-5 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <label for="netease-url-input" class="text-sm font-medium text-gray-700">从网易云链接提取</label>
                            <input type="text" id="netease-url-input" placeholder="粘贴歌曲/专辑的分享文本或链接..."
                                class="w-full h-10 px-3 light-input">
                            <div class="flex gap-2">
                                <select id="netease-slot-select"
                                    class="flex-grow h-10 px-3 light-input text-sm focus:ring-0">
                                    <!-- Options 动态生成 -->
                                </select>
                                <button id="netease-fetch-btn"
                                    class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-md text-sm whitespace-nowrap flex items-center justify-center disabled:bg-gray-400"
                                    style="min-width: 80px;">
                                    <span id="netease-btn-text">提取</span>
                                    <div id="netease-loader" class="loader hidden"></div>
                                </button>
                            </div>
                            <div id="netease-msg" class="text-xs text-center hidden"></div>
                        </div>

                        <h3 class="text-md font-semibold text-gray-800 mb-3">手动上传 (1-9 张)</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <!-- 插槽 1-9 -->
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-1">
                                <img id="preview-1"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览1">
                                <button id="delete-1" data-slot="1"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 1</span>
                                <input type="file" accept="image/*" id="upload-1" data-slot="1">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-2">
                                <img id="preview-2"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览2">
                                <button id="delete-2" data-slot="2"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 2</span>
                                <input type="file" accept="image/*" id="upload-2" data-slot="2">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-3">
                                <img id="preview-3"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览3">
                                <button id="delete-3" data-slot="3"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 3</span>
                                <input type="file" accept="image/*" id="upload-3" data-slot="3">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-4">
                                <img id="preview-4"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览4">
                                <button id="delete-4" data-slot="4"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 4</span>
                                <input type="file" accept="image/*" id="upload-4" data-slot="4">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-5">
                                <img id="preview-5"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览5">
                                <button id="delete-5" data-slot="5"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 5</span>
                                <input type="file" accept="image/*" id="upload-5" data-slot="5">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-6">
                                <img id="preview-6"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览6">
                                <button id="delete-6" data-slot="6"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 6</span>
                                <input type="file" accept="image/*" id="upload-6" data-slot="6">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-7">
                                <img id="preview-7"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览7">
                                <button id="delete-7" data-slot="7"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 7</span>
                                <input type="file" accept="image/*" id="upload-7" data-slot="7">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-8">
                                <img id="preview-8"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览8">
                                <button id="delete-8" data-slot="8"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 8</span>
                                <input type="file" accept="image/*" id="upload-8" data-slot="8">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-9">
                                <img id="preview-9"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览9">
                                <button id="delete-9" data-slot="9"
                                    class="delete-btn absolute top-1 right-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full z-20 hidden items-center justify-center text-xs leading-none font-bold">&times;</button>
                                <span class="text-xs z-0">插槽 9</span>
                                <input type="file" accept="image/*" id="upload-9" data-slot="9">
                            </div>
                        </div>
                    </div>

                    <!-- 4. 样式和操作 -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">4. 样式与操作</h2>
                        <div class="flex flex-col">
                            <label for="bg-color" class="text-sm font-medium text-gray-700 mb-2">海报背景色</label>
                            <input id="bg-color" type="color" value="#F4F4F8"
                                class="w-full h-10 p-1 rounded-md light-input cursor-pointer appearance-none border-gray-300">
                        </div>
                        <div class="flex flex-col">
                            <label for="poster-padding" class="text-sm font-medium text-gray-700 mb-2">海报内边距: <span
                                    id="padding-value">180</span>px</label>
                            <input id="poster-padding" type="range" value="180" min="60" max="450" class="w-full">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <button id="clear-btn"
                                class="w-full py-3 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition-colors shadow-md">
                                清空
                            </button>
                            <button id="download-btn"
                                class="w-full py-3 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-lg shadow-red-600/30">
                                下载海报
                            </button>
                        </div>
                    </div>

                </div>
            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全局状态 ---
            const CANVAS_SIZE = 3000;
            const canvas = document.getElementById('poster-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // sourceUrls 用于存储可分享的源 URL
            let sourceUrls = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null };
            let loadedImages = {}; // 存储加载的 Image 对象
            let noisePatternCanvas = null; // 用于存储噪点图案

            // --- DOM 元素 ---
            const textTitle = document.getElementById('poster-title');
            const textSharer = document.getElementById('poster-sharer');
            const templateRadios = document.querySelectorAll('input[name="template"]');
            const bgColorInput = document.getElementById('bg-color');
            const paddingInput = document.getElementById('poster-padding');
            const paddingValueDisplay = document.getElementById('padding-value');
            const uploadInputs = document.querySelectorAll('input[type="file"]');
            const clearBtn = document.getElementById('clear-btn');
            const downloadBtn = document.getElementById('download-btn');
            const neteaseUrlInput = document.getElementById('netease-url-input');
            const neteaseSlotSelect = document.getElementById('netease-slot-select');
            const neteaseFetchBtn = document.getElementById('netease-fetch-btn');
            const neteaseBtnText = document.getElementById('netease-btn-text');
            const neteaseLoader = document.getElementById('netease-loader');
            const neteaseMsg = document.getElementById('netease-msg');
            const deleteBtns = document.querySelectorAll('.delete-btn');

            const CORS_PROXIES = [
                "https://music-api.chehil.icu/?url=",
                "https://netease-proxy.echehil.workers.dev/?url=",
                "https://api.allorigins.win/raw?url=",
                "https://corsproxy.io/?",
                "https://api.codetabs.com/v1/proxy?quest="
            ];

            async function fetchWithProxies(targetUrl) {
                let lastError = null;

                for (const base of CORS_PROXIES) {
                    try {
                        const proxyUrl = `${base}${encodeURIComponent(targetUrl)}`;
                        const resp = await fetch(proxyUrl);

                        if (!resp.ok) {
                            throw new Error(`网络错误 (代理 ${base}): ${resp.status}`);
                        }

                        return await resp.text();
                    } catch (e) {
                        console.warn("代理失败:", base, e);
                        lastError = e;
                    }
                }

                throw lastError || new Error("所有代理都请求失败");
            }

            // --- 状态更新函数 ---

            /**
             * 将当前所有配置编码到 URL
             * (使用 Base64 压缩以支持中文和长 URL)
             */
            function updateUrl() {
                try {
                    const state = {
                        title: textTitle.value,
                        sharer: textSharer.value,
                        layout: document.querySelector('input[name="template"]:checked').value,
                        bgColor: bgColorInput.value,
                        padding: paddingInput.value,
                        images: sourceUrls // 只保存可分享的 URL
                    };

                    const jsonString = JSON.stringify(state);
                    const utf8State = unescape(encodeURIComponent(jsonString));
                    const base64State = btoa(utf8State);

                    const params = new URLSearchParams();
                    params.set('data', base64State);
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);

                } catch (e) {
                    console.error("更新 URL 失败:", e);
                }
            }

            /**
             * 页面加载时，从 URL 解码并加载状态
             */
            async function loadStateFromUrl() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const base64State = params.get('data');

                    if (!base64State) {
                        drawPoster();
                        return;
                    }

                    showNeteaseMessage('正在从链接加载配置...', 'loading');

                    const jsonString = decodeURIComponent(escape(atob(base64State)));
                    const state = JSON.parse(jsonString);

                    textTitle.value = state.title || '';
                    textSharer.value = state.sharer || '';
                    bgColorInput.value = state.bgColor || '#F4F4F8';
                    paddingInput.value = state.padding || '180';
                    paddingValueDisplay.textContent = state.padding || '180';

                    const layoutValue = state.layout || 'grid-3x3';
                    const layoutRadio = document.getElementById('template-' + layoutValue);
                    if (layoutRadio) layoutRadio.checked = true;

                    const imageLoadPromises = [];
                    if (state.images) {
                        for (let i = 1; i <= 9; i++) {
                            const url = state.images[i];
                            if (url) {
                                sourceUrls[i] = url;
                                const previewImg = document.getElementById(`preview-${i}`);
                                if (previewImg) {
                                    previewImg.src = url;
                                    previewImg.classList.remove('hidden');
                                }
                                const deleteBtn = document.getElementById(`delete-${i}`);
                                if (deleteBtn) {
                                    deleteBtn.classList.remove('hidden');
                                }
                                imageLoadPromises.push(loadImage(url, i));
                            }
                        }
                    }

                    await Promise.allSettled(imageLoadPromises);
                    showNeteaseMessage('配置加载完毕!', 'success');
                    setTimeout(() => showNeteaseMessage('', 'hidden'), 2000);

                } catch (e) {
                    console.error("从 URL 加载状态失败:", e);
                    showNeteaseMessage('链接解析失败!', 'error');
                } finally {
                    drawPoster();
                }
            }

            // --- 初始化 ---
            noisePatternCanvas = createNoisePattern();
            populateSlotSelector();
            loadStateFromUrl();


            // --- 事件监听器 ---
            [textTitle, textSharer, bgColorInput, paddingInput].forEach(el => {
                el.addEventListener('input', () => {
                    drawPoster();
                    updateUrl();
                });
            });
            templateRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    drawPoster();
                    updateUrl();
                });
            });
            paddingInput.addEventListener('input', () => {
                paddingValueDisplay.textContent = paddingInput.value;
            });
            uploadInputs.forEach(input => {
                input.addEventListener('change', (e) => handleFileChange(e, input.dataset.slot));
            });
            clearBtn.addEventListener('click', clearAll);
            downloadBtn.addEventListener('click', downloadPoster);
            deleteBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    clearSlot(btn.dataset.slot);
                });
            });

            neteaseFetchBtn.addEventListener('click', handleNeteaseFetch);
            neteaseUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleNeteaseFetch();
            });


            // --- 核心函数 ---

            /**
            * 创建一个 200x200 的噪点图案
            * @returns {HTMLCanvasElement}
            */
            function createNoisePattern() {
                const size = 200;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(size, size);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const noise = Math.random() * 255;
                    data[i] = noise;
                    data[i + 1] = noise;
                    data[i + 2] = noise;
                    data[i + 3] = 255;
                }
                ctx.putImageData(imageData, 0, 0);
                return canvas;
            }

            function clearSlot(slot) {
                sourceUrls[slot] = null;
                loadedImages[slot] = null;

                const previewImg = document.getElementById(`preview-${slot}`);
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.classList.add('hidden');
                }
                const deleteBtn = document.getElementById(`delete-${slot}`);
                if (deleteBtn) {
                    deleteBtn.classList.add('hidden');
                }
                const fileInput = document.getElementById(`upload-${slot}`);
                if (fileInput) {
                    fileInput.value = null;
                }
                drawPoster();
                updateUrl();
            }

            function populateSlotSelector() {
                for (let i = 1; i <= 9; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `到插槽 ${i}`;
                    neteaseSlotSelect.appendChild(option);
                }
            }

            /**
             * 提取网易云封面 (V2 - 三级降级策略)
             */
            async function handleNeteaseFetch() {
                const rawInput = neteaseUrlInput.value.trim();
                const targetSlot = neteaseSlotSelect.value;
                if (!rawInput) {
                    showNeteaseMessage('请输入分享文本或URL', 'error');
                    return;
                }
                setNeteaseLoading(true);
                showNeteaseMessage('正在识别链接...', 'loading');

                try {
                    // 1. 在输入中找到 URL
                    const urlRegex = /(https?:\/\/[^\s"'()]+)/;
                    const urlMatch = rawInput.match(urlRegex);
                    if (!urlMatch) throw new Error('未在输入内容中找到有效的URL。');

                    let targetUrl = urlMatch[0].replace("/#/", "/"); // 清理 hash 路由
                    showNeteaseMessage('识别到URL，正在分析...', 'loading');

                    let imageUrl = null;
                    let htmlContent = null; // 存储 HTML 内容以便复用

                    // 2. 分析 URL
                    const idRegex = /(song|album)\?id=(\d+)/;
                    const idMatch = targetUrl.match(idRegex);
                    const isShortLink = targetUrl.includes('163.fm');

                    // --- 策略 1: API (最优先) ---
                    // (前提: 不是短链接，且能匹配到 song/album ID)
                    if (idMatch && !isShortLink) {
                        try {
                            const resourceType = idMatch[1]; // 'song' 或 'album'
                            const id = idMatch[2];
                            showNeteaseMessage('发现ID，尝试API... (1/3)', 'loading');

                            let apiUrl;
                            if (resourceType === 'song') {
                                apiUrl = `https://music.163.com/api/song/detail?ids=${id}`;
                            } else { // 'album'
                                apiUrl = `https://music.163.com/api/album/${id}`;
                            }

                            const jsonString = await fetchWithProxies(apiUrl);
                            const data = JSON.parse(jsonString);

                            if (resourceType === 'song') {
                                imageUrl = data?.songs?.[0]?.album?.picUrl;
                            } else { // 'album'
                                imageUrl = data?.album?.picUrl;
                            }

                            if (!imageUrl) throw new Error('API 成功，但未找到图片URL。');
                            
                            showNeteaseMessage('API 提取成功！', 'success');

                        } catch (apiError) {
                            console.warn("API 提取失败:", apiError.message);
                            // API 失败，降级到策略 2，不抛出错误
                        }
                    }

                    // --- 策略 2: HTML 'og:image' 解析 (次优先) ---
                    // (前提: 策略 1 未执行或失败)
                    if (!imageUrl) {
                        try {
                            showNeteaseMessage(isShortLink ? '解析短链中...' : '尝试HTML解析... (2/3)', 'loading');
                            
                            htmlContent = await fetchWithProxies(targetUrl);
                            showNeteaseMessage('解析HTML, 查找封面...', 'loading');
                            
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(htmlContent, 'text/html');
                            const ogImageTag = doc.querySelector("meta[property='og:image']");
                            
                            imageUrl = ogImageTag?.getAttribute('content');

                            if (!imageUrl) {
                                throw new Error('无法在此页面找到封面图片(og:image)。');
                            }
                            showNeteaseMessage('HTML og:image 提取成功！', 'success');

                        } catch (htmlError) {
                            console.warn("HTML 'og:image' 提取失败:", htmlError.message);
                            // HTML 解析失败，降级到策略 3，不抛出错误
                        }
                    }

                    // --- 策略 3: Regex 暴力搜索 (保底) ---
                    // (前提: 策略 1 和 2 均失败)
                    if (!imageUrl) {
                        try {
                            // 如果策略 2 失败了但获取到了 HTML，则复用
                            if (!htmlContent) { 
                                showNeteaseMessage('尝试抓取HTML... (3/3)', 'loading');
                                htmlContent = await fetchWithProxies(targetUrl);
                            }
                            showNeteaseMessage('尝试暴力搜索... (3/3)', 'loading');

                            // 优先匹配网易云 CDN (p1.music.126.net/...)
                            const jpgRegex = /(https?:\/\/p\d+\.music\.126\.net\/[^"']+\.jpg)/;
                            const regexMatch = htmlContent.match(jpgRegex);
                            
                            imageUrl = regexMatch?.[0];

                            if (!imageUrl) {
                                throw new Error('已尝试所有方法，均未找到图片。');
                            }
                            showNeteaseMessage('暴力搜索提取成功！', 'success');
                            
                        } catch (regexError) {
                            console.error("Regex 提取失败:", regexError);
                            // 这是最后的机会，如果还失败，则彻底失败
                            throw regexError;
                        }
                    }

                    // --- 统一处理成功获取的 imageUrl ---
                    const baseUrl = imageUrl.split('?')[0];
                    const hdUrl = `${baseUrl}?param=3000y3000`;

                    // 存储可分享的 URL
                    sourceUrls[targetSlot] = hdUrl;

                    // 更新 UI 预览
                    const previewImg = document.getElementById(`preview-${targetSlot}`);
                    if (previewImg) {
                        previewImg.src = hdUrl;
                        previewImg.classList.remove('hidden');
                    }
                    const deleteBtn = document.getElementById(`delete-${targetSlot}`);
                    if (deleteBtn) {
                        deleteBtn.classList.remove('hidden');
                    }
                    const fileInput = document.getElementById(`upload-${targetSlot}`);
                    if (fileInput) fileInput.value = null;

                    // 异步加载图片
                    await loadImage(hdUrl, targetSlot);

                    // 重绘并更新 URL
                    drawPoster();
                    updateUrl();

                    showNeteaseMessage(`成功提取到插槽 ${targetSlot}！`, 'success');
                    neteaseUrlInput.value = '';

                    // 自动跳到下一个插槽
                    let currentSlot = parseInt(neteaseSlotSelect.value, 10);
                    let nextSlot = currentSlot + 1;
                    if (nextSlot > 9) {
                        nextSlot = 1; // 循环回1
                    }
                    neteaseSlotSelect.value = nextSlot.toString();

                } catch (err) {
                    // --- 最终失败处理 ---
                    console.error("提取失败 (所有方法):", err);
                    showNeteaseMessage(err.message || '提取失败，请重试。', 'error');
                    sourceUrls[targetSlot] = null; // 确保失败时清除
                } finally {
                    setNeteaseLoading(false);
                }
            }


            function setNeteaseLoading(isLoading) {
                if (isLoading) {
                    neteaseFetchBtn.disabled = true;
                    neteaseBtnText.classList.add('hidden');
                    neteaseLoader.classList.remove('hidden');
                } else {
                    neteaseFetchBtn.disabled = false;
                    neteaseBtnText.classList.remove('hidden');
                    neteaseLoader.classList.add('hidden');
                }
            }

            function showNeteaseMessage(message, type = 'loading') {
                if (type === 'hidden') {
                    neteaseMsg.classList.add('hidden');
                    return;
                }
                neteaseMsg.textContent = message;
                neteaseMsg.classList.remove('hidden', 'text-gray-500', 'text-green-600', 'text-red-500');
                if (type === 'error') neteaseMsg.classList.add('text-red-500');
                else if (type === 'success') neteaseMsg.classList.add('text-green-600');
                else neteaseMsg.classList.add('text-gray-500');
            }

            /**
             * 处理文件上传
             */
            function handleFileChange(event, slot) {
                showNeteaseMessage('', 'hidden');
                sourceUrls[slot] = null; // 本地上传，清除分享 URL

                const file = event.target.files[0];
                if (!file) {
                    clearSlot(slot);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataURL = e.target.result;
                    const previewImg = document.getElementById(`preview-${slot}`);
                    if (previewImg) {
                        previewImg.src = dataURL;
                        previewImg.classList.remove('hidden');
                    }
                    const deleteBtn = document.getElementById(`delete-${slot}`);
                    if (deleteBtn) {
                        deleteBtn.classList.remove('hidden');
                    }
                    loadImage(dataURL, slot).then(() => {
                        drawPoster();
                        updateUrl();
                    });
                };
                reader.readAsDataURL(file);
            }

            /**
             * 异步加载图像
             */
            function loadImage(src, slot) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        loadedImages[slot] = img;
                        resolve(img);
                    };
                    img.onerror = (err) => {
                        console.error(`Failed to load image for slot ${slot}:`, src, err);
                        loadedImages[slot] = null;
                        sourceUrls[slot] = null;
                        const previewImg = document.getElementById(`preview-${slot}`);
                        if (previewImg) {
                            previewImg.src = '';
                            previewImg.classList.add('hidden');
                        }
                        const deleteBtn = document.getElementById(`delete-${slot}`);
                        if (deleteBtn) {
                            deleteBtn.classList.add('hidden');
                        }
                        drawPoster();
                        updateUrl();
                        reject(err);
                    };
                    img.src = src;
                });
            }

            /**
             * 主绘制函数
             */
            function drawPoster() {
                const settings = {
                    title: textTitle.value || "顔色推歌",
                    sharer: textSharer.value || "填表人：",
                    template: document.querySelector('input[name="template"]:checked').value,
                    bgColor: bgColorInput.value || '#F4F4F8',
                    padding: parseInt(paddingInput.value, 10) || 180,
                };
                const activeImages = [];
                for (let i = 1; i <= 9; i++) {
                    if (loadedImages[i]) {
                        activeImages.push(loadedImages[i]);
                    }
                }

                const textColors = getContrastingTextColors(settings.bgColor);
                drawBackground(settings.bgColor, activeImages.length === 0, textColors);

                const TOP_TEXT_ZONE_HEIGHT = 450;
                const BOTTOM_TEXT_ZONE_HEIGHT = 300;
                const contentBox = {
                    x: settings.padding,
                    y: settings.padding + TOP_TEXT_ZONE_HEIGHT,
                    width: CANVAS_SIZE - settings.padding * 2,
                    height: CANVAS_SIZE - (settings.padding * 2) - TOP_TEXT_ZONE_HEIGHT - BOTTOM_TEXT_ZONE_HEIGHT
                };
                switch (settings.template) {
                    case 'hero': drawHeroLayout(activeImages, contentBox); break;
                    case 'grid-2x2': drawGrid2x2Layout(activeImages, contentBox); break;
                    case 'grid-3x3': drawGrid3x3Layout(activeImages, contentBox); break;
                }
                drawText(settings, textColors);
            }

            /**
             * 绘制背景
             */
            function drawBackground(color, showHint, textColors) {
                ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                if (noisePatternCanvas) {
                    ctx.save();
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.globalAlpha = 0.15;
                    ctx.fillStyle = ctx.createPattern(noisePatternCanvas, 'repeat');
                    ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                    ctx.restore();
                }

                const colors = textColors || getContrastingTextColors(color);
                if (showHint) {
                    ctx.fillStyle = colors.hint;
                    ctx.font = '90px "STDongGuanTi", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('请在侧边栏上传或提取专辑封面', CANVAS_SIZE / 2, CANVAS_SIZE / 2);
                }
            }

            // --- 颜色辅助函数 ---

            function hexToRgb(hex) {
                hex = hex.replace('#', '');
                if (hex.length === 3) {
                    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
                }
                if (hex.length !== 6) {
                    return { r: NaN, g: NaN, b: NaN };
                }
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                return { r, g, b };
            }

            function getRelativeLuminance({ r, g, b }) {
                const srgb = [r, g, b].map(v => v / 255);
                const [R, G, B] = srgb.map(v =>
                    v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4)
                );
                return 0.2126 * R + 0.7152 * G + 0.0722 * B;
            }

            function getContrastRatio(L1, L2) {
                const light = Math.max(L1, L2);
                const dark = Math.min(L1, L2);
                return (light + 0.05) / (dark + 0.05);
            }

            /**
             * 根据背景色自动选择适合的文字颜色 (WCAG)
             */
            function getContrastingTextColors(bgColor) {
                const defaultColors = { main: '#111827', secondary: '#374151', hint: '#4B5563' };
                try {
                    if (!bgColor) return defaultColors;
                    const bgRgb = hexToRgb(bgColor);
                    if (isNaN(bgRgb.r)) return defaultColors;

                    const bgL = getRelativeLuminance(bgRgb);
                    const contrastWithBlack = getContrastRatio(bgL, 0);
                    const contrastWithWhite = getContrastRatio(bgL, 1);

                    if (contrastWithBlack >= contrastWithWhite) {
                        // 背景偏亮 -> 文字用深色系
                        return { main: '#111827', secondary: '#374151', hint: '#4B5563' };
                    } else {
                        // 背景偏暗 -> 文字用浅色系
                        return { main: '#F9FAFB', secondary: '#E5E7EB', hint: '#9CA3AF' };
                    }
                } catch (e) {
                    console.error("解析颜色失败:", bgColor, e);
                    return defaultColors;
                }
            }

            /**
             * 辅助: 绘制文本
             */
            function drawText(settings, textColors) {
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                const padding = settings.padding;
                const TOP_TEXT_ZONE_HEIGHT = 450;
                const BOTTOM_TEXT_ZONE_HEIGHT = 300;

                const { main, secondary } = textColors || getContrastingTextColors(settings.bgColor);

                // 标题
                ctx.fillStyle = main;
                ctx.font = 'bold 156px "STDongGuanTi", "Noto Serif SC", serif';
                ctx.textAlign = 'center';
                const titleY = padding + (TOP_TEXT_ZONE_HEIGHT / 2) + 45;
                ctx.fillText(settings.title, CANVAS_SIZE / 2, titleY);

                // 分享人
                ctx.font = 'normal 84px "Zhuque Fangsong (technical preview)", "Noto Sans SC", sans-serif';
                ctx.fillStyle = secondary;
                ctx.textAlign = 'center';
                const sharerY = (CANVAS_SIZE - padding - BOTTOM_TEXT_ZONE_HEIGHT) + (BOTTOM_TEXT_ZONE_HEIGHT / 2) + 30;
                ctx.fillText(settings.sharer, CANVAS_SIZE / 2, sharerY);
            }

            // --- 布局绘制函数 ---

            function drawHeroLayout(images, box) {
                const gap = 60;
                if (!images[0]) return;
                const heroSize = box.height;
                const smallSize = (box.height - gap) / 2;
                const totalWidth = heroSize + gap + smallSize;
                const startX = box.x + (box.width - totalWidth) / 2;
                drawSquareCover(images[0], startX, box.y, heroSize);
                if (images[1]) drawSquareCover(images[1], startX + heroSize + gap, box.y, smallSize);
                if (images[2]) drawSquareCover(images[2], startX + heroSize + gap, box.y + smallSize + gap, smallSize);
            }

            function drawGrid2x2Layout(images, box) {
                const gap = 60;
                let size = (box.width - gap) / 2;
                if (size * 2 + gap > box.height) size = (box.height - gap) / 2;
                const startX = box.x + (box.width - (size * 2 + gap)) / 2;
                const startY = box.y + (box.height - (size * 2 + gap)) / 2;
                if (images[0]) drawSquareCover(images[0], startX, startY, size);
                if (images[1]) drawSquareCover(images[1], startX + size + gap, startY, size);
                if (images[2]) drawSquareCover(images[2], startX, startY + size + gap, size);
                if (images[3]) drawSquareCover(images[3], startX + size + gap, startY + size + gap, size);
            }

            function drawGrid3x3Layout(images, box) {
                const gap = 60;
                let size = (box.width - gap * 2) / 3;
                if (size * 3 + gap * 2 > box.height) size = (box.height - gap * 2) / 3;
                const totalWidth = size * 3 + gap * 2;
                const totalHeight = size * 3 + gap * 2;
                const startX = box.x + (box.width - totalWidth) / 2;
                const startY = box.y + (box.height - totalHeight) / 2;
                for (let i = 0; i < 9; i++) {
                    if (images[i]) {
                        const row = Math.floor(i / 3);
                        const col = i % 3;
                        const x = startX + col * (size + gap);
                        const y = startY + row * (size + gap);
                        drawSquareCover(images[i], x, y, size);
                    }
                }
            }

            function drawSquareCover(img, dx, dy, dSize) {
                if (!img || !img.width || !img.height) return;
                const sMin = Math.min(img.width, img.height);
                const sx = (img.width - sMin) / 2;
                const sy = (img.height - sMin) / 2;
                const cornerRadius = 24;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(dx + cornerRadius, dy);
                ctx.lineTo(dx + dSize - cornerRadius, dy);
                ctx.quadraticCurveTo(dx + dSize, dy, dx + dSize, dy + cornerRadius);
                ctx.lineTo(dx + dSize, dy + dSize - cornerRadius);
                ctx.quadraticCurveTo(dx + dSize, dy + dSize, dx + dSize - cornerRadius, dy + dSize);
                ctx.lineTo(dx + cornerRadius, dy + dSize);
                ctx.quadraticCurveTo(dx, dy + dSize, dx, dy + dSize - cornerRadius);
                ctx.lineTo(dx, dy + cornerRadius);
                ctx.quadraticCurveTo(dx, dy, dx + cornerRadius, dy);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(img, sx, sy, sMin, sMin, dx, dy, dSize, dSize);
                ctx.restore();
            }

            /**
             * 清空所有
             */
            function clearAll() {
                sourceUrls = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null };
                loadedImages = {};

                uploadInputs.forEach((input, index) => {
                    input.value = null;
                    const slot = index + 1;
                    const previewImg = document.getElementById(`preview-${slot}`);
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.classList.add('hidden');
                    }
                    const deleteBtn = document.getElementById(`delete-${slot}`);
                    if (deleteBtn) {
                        deleteBtn.classList.add('hidden');
                    }
                });

                textTitle.value = '';
                textSharer.value = '';
                bgColorInput.value = '#F4F4F8';
                paddingInput.value = '180';
                paddingValueDisplay.textContent = '180';
                document.getElementById('template-grid-3x3').checked = true;

                neteaseUrlInput.value = '';
                neteaseSlotSelect.value = '1';
                showNeteaseMessage('', 'hidden');

                drawPoster();
                window.history.pushState({}, '', window.location.pathname);
            }

            function downloadPoster() {
                try {
                    const link = document.createElement('a');
                    link.download = `${textTitle.value || 'music-poster'}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    console.error("下载失败:", e);
                    showNeteaseMessage('下载失败 (可能CORS错误)', 'error');
                }
            }
        });
    </script>

</body>

</html>