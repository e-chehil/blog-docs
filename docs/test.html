<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专辑海报设计 V10 (链接分享状态)</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 引入自定义字体 (STDongGuanTi 和 Zhuque Fangsong) -->
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/488/main/result.css">
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/7/main/result.css">

    <style>
        /* [V9] 全局应用新字体 */
        body {
            font-family: "STDongGuanTi", 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .light-panel {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .template-selector input[type="radio"] {
            display: none;
        }

        .template-selector label {
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 8px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .template-selector input[type="radio"]:checked+label {
            background-color: #C81E1E;
            color: #FFFFFF;
            border-color: #EF4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .template-selector label:hover {
            background-color: #f3f4f6;
        }

        .light-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111827;
            border-radius: 0.375rem;
        }

        .light-input:focus {
            outline: none;
            border-color: #EF4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }

        .light-slot {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            color: #9ca3af;
            transition: all 0.2s ease-in-out;
        }

        .light-slot:hover {
            border-color: #EF4444;
            color: #ef4444;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 标题 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold" style="font-family: 'STDongGuanTi', serif; color: #C81E1E;">
                专辑海报设计 V10
            </h1>
            <p class="text-gray-600 mt-2" style="font-family: 'Zhuque Fangsong (technical preview)', sans-serif;">
                链接分享 · 3000px 高清画布
            </p>
        </header>

        <!-- 主内容区 -->
        <main class="flex flex-col md:flex-row gap-6 md:gap-8">

            <!-- 画布预览 -->
            <section class="w-full md:w-2/3 lg:w-2/3">
                <div class="w-full light-panel p-2 sticky top-8">
                    <canvas id="poster-canvas" width="3000" height="3000"
                        class="w-full h-auto rounded-lg aspect-square"></canvas>
                </div>
            </section>

            <!-- 控制面板 -->
            <aside class="w-full md:w-1/3 lg:w-1/3 shrink-0">
                <div class="light-panel p-5 md:p-6 flex flex-col gap-6">

                    <!-- 1. 海报文本 -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">1. 海报文本</h2>
                        <div>
                            <label for="poster-title" class="text-sm font-medium text-gray-700 mb-1 block">标题</label>
                            <input type="text" id="poster-title" placeholder="顔色推歌"
                                class="w-full h-10 px-3 light-input">
                        </div>
                        <div>
                            <label for="poster-sharer" class="text-sm font-medium text-gray-700 mb-1 block">分享人</label>
                            <input type="text" id="poster-sharer" placeholder="填表人："
                                class="w-full h-10 px-3 light-input">
                        </div>
                    </div>

                    <!-- 2. 选择布局 -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">2. 选择布局</h2>
                        <div class="grid grid-cols-3 gap-3 template-selector">
                            <!-- 模板: Hero (3) -->
                            <div>
                                <input type="radio" name="template" id="template-hero" value="hero">
                                <label for="template-hero">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4h10v10H4zM16 4h4v4h-4zM16 10h4v4h-4z"></path>
                                    </svg>
                                    精选 (3图)
                                </label>
                            </div>
                            <!-- 模板: Grid (4) -->
                            <div>
                                <input type="radio" name="template" id="template-grid-2x2" value="grid-2x2">
                                <label for="template-grid-2x2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                                        </path>
                                    </svg>
                                    网格 (4图)
                                </label>
                            </div>
                            <!-- 模板: Grid (9) -->
                            <div>
                                <input type="radio" name="template" id="template-grid-3x3" value="grid-3x3" checked>
                                <label for="template-grid-3x3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                            d="M3 3h4v4H3zM10 3h4v4h-4zM17 3h4v4h-4zM3 10h4v4H3zM10 10h4v4h-4zM17 10h4v4h-4zM3 17h4v4H3zM10 17h4v4h-4zM17 17h4v4h-4z">
                                        </path>
                                    </svg>
                                    九宫格 (9图)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 上传 / 提取封面 -->
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 mb-4">3. 上传 / 提取封面
                        </h2>
                        <div class="flex flex-col gap-3 mb-5 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <label for="netease-url-input" class="text-sm font-medium text-gray-700">从网易云链接提取</label>
                            <input type="text" id="netease-url-input" placeholder="粘贴歌曲/专辑的分享文本或链接..."
                                class="w-full h-10 px-3 light-input">
                            <div class="flex gap-2">
                                <select id="netease-slot-select"
                                    class="flex-grow h-10 px-3 light-input text-sm focus:ring-0">
                                    <!-- Options 动态生成 -->
                                </select>
                                <button id="netease-fetch-btn"
                                    class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-md text-sm whitespace-nowrap flex items-center justify-center disabled:bg-gray-400"
                                    style="min-width: 80px;">
                                    <span id="netease-btn-text">提取</span>
                                    <div id="netease-loader" class="loader hidden"></div>
                                </button>
                            </div>
                            <div id="netease-msg" class="text-xs text-center hidden"></div>
                        </div>

                        <h3 class="text-md font-semibold text-gray-800 mb-3">手动上传 (1-9 张)</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <!-- 插槽 1-9 -->
                            <!-- ... 省略 9 个插槽的 HTML (与V9相同) ... -->
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-1">
                                <img id="preview-1"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览1">
                                <span class="text-xs z-0">插槽 1</span>
                                <input type="file" accept="image/*" id="upload-1" data-slot="1">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-2">
                                <img id="preview-2"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览2">
                                <span class="text-xs z-0">插槽 2</span>
                                <input type="file" accept="image/*" id="upload-2" data-slot="2">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-3">
                                <img id="preview-3"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览3">
                                <span class="text-xs z-0">插槽 3</span>
                                <input type="file" accept="image/*" id="upload-3" data-slot="3">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-4">
                                <img id="preview-4"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览4">
                                <span class="text-xs z-0">插槽 4</span>
                                <input type="file" accept="image/*" id="upload-4" data-slot="4">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-5">
                                <img id="preview-5"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览5">
                                <span class="text-xs z-0">插槽 5</span>
                                <input type="file" accept="image/*" id="upload-5" data-slot="5">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-6">
                                <img id="preview-6"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览6">
                                <span class="text-xs z-0">插槽 6</span>
                                <input type="file" accept="image/*" id="upload-6" data-slot="6">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-7">
                                <img id="preview-7"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览7">
                                <span class="text-xs z-0">插槽 7</span>
                                <input type="file" accept="image/*" id="upload-7" data-slot="7">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-8">
                                <img id="preview-8"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览8">
                                <span class="text-xs z-0">插槽 8</span>
                                <input type="file" accept="image/*" id="upload-8" data-slot="8">
                            </div>
                            <div class="relative aspect-square light-slot rounded-lg flex items-center justify-center text-center"
                                id="slot-container-9">
                                <img id="preview-9"
                                    class="absolute inset-0 w-full h-full object-cover rounded-md z-10 hidden"
                                    alt="预览9">
                                <span class="text-xs z-0">插槽 9</span>
                                <input type="file" accept="image/*" id="upload-9" data-slot="9">
                            </div>
                        </div>
                    </div>

                    <!-- 4. 样式和操作 -->
                    <div class="flex flex-col gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">4. 样式与操作</h2>
                        <div class="flex flex-col">
                            <label for="bg-color" class="text-sm font-medium text-gray-700 mb-2">海报背景色</label>
                            <input id="bg-color" type="color" value="#F4F4F8"
                                class="w-full h-10 p-1 rounded-md light-input cursor-pointer appearance-none border-gray-300">
                        </div>
                        <div class="flex flex-col">
                            <label for="poster-padding" class="text-sm font-medium text-gray-700 mb-2">海报内边距: <span
                                    id="padding-value">180</span>px</label>
                            <input id="poster-padding" type="range" value="180" min="60" max="450" class="w-full">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <button id="clear-btn"
                                class="w-full py-3 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition-colors shadow-md">
                                清空
                            </button>
                            <button id="download-btn"
                                class="w-full py-3 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-lg shadow-red-600/30">
                                下载海报
                            </button>
                        </div>
                    </div>

                </div>
            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全局状态 ---
            const CANVAS_SIZE = 3000;
            const canvas = document.getElementById('poster-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // [V10] sourceUrls 用于存储可分享的源 URL
            let sourceUrls = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null };
            let loadedImages = {}; // 存储加载的 Image 对象

            // --- DOM 元素 ---
            const textTitle = document.getElementById('poster-title');
            const textSharer = document.getElementById('poster-sharer');
            const templateRadios = document.querySelectorAll('input[name="template"]');
            const bgColorInput = document.getElementById('bg-color');
            const paddingInput = document.getElementById('poster-padding');
            const paddingValueDisplay = document.getElementById('padding-value');
            const uploadInputs = document.querySelectorAll('input[type="file"]');
            const clearBtn = document.getElementById('clear-btn');
            const downloadBtn = document.getElementById('download-btn');
            const neteaseUrlInput = document.getElementById('netease-url-input');
            const neteaseSlotSelect = document.getElementById('netease-slot-select');
            const neteaseFetchBtn = document.getElementById('netease-fetch-btn');
            const neteaseBtnText = document.getElementById('netease-btn-text');
            const neteaseLoader = document.getElementById('netease-loader');
            const neteaseMsg = document.getElementById('netease-msg');

            const CORS_PROXY_URL = "https://api.allorigins.win/raw?url=";

            // --- [V10] 状态更新函数 ---

            /**
             * [V10] 将当前所有配置编码到 URL
             * (使用 Base64 压缩以支持中文和长 URL)
             */
            function updateUrl() {
                try {
                    const state = {
                        title: textTitle.value,
                        sharer: textSharer.value,
                        layout: document.querySelector('input[name="template"]:checked').value,
                        bgColor: bgColorInput.value,
                        padding: paddingInput.value,
                        images: sourceUrls // 只保存可分享的 URL
                    };

                    // 1. 将 state 转换成 JSON 字符串
                    const jsonString = JSON.stringify(state);

                    // 2. 健壮的 UTF-8 -> Base64 编码
                    // (防止 'btoa' 在遇到中文字符时出错)
                    const utf8State = unescape(encodeURIComponent(jsonString));
                    const base64State = btoa(utf8State);

                    // 3. 创建新的 URL
                    const params = new URLSearchParams();
                    params.set('data', base64State);
                    const newUrl = `${window.location.pathname}?${params.toString()}`;

                    // 4. 更新 URL (不刷新页面)
                    window.history.pushState({ path: newUrl }, '', newUrl);

                } catch (e) {
                    console.error("更新 URL 失败:", e);
                }
            }

            /**
             * [V10] 页面加载时，从 URL 解码并加载状态
             */
            async function loadStateFromUrl() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const base64State = params.get('data');

                    if (!base64State) {
                        // 没有 data 参数，正常绘制
                        drawPoster();
                        return;
                    }

                    showNeteaseMessage('正在从链接加载配置...', 'loading');

                    // 1. 健壮的 Base64 -> UTF-8 解码
                    const jsonString = decodeURIComponent(escape(atob(base64State)));
                    const state = JSON.parse(jsonString);

                    // 2. 应用文本和设置
                    textTitle.value = state.title || '';
                    textSharer.value = state.sharer || '';
                    bgColorInput.value = state.bgColor || '#F4F4F8';
                    paddingInput.value = state.padding || '180';
                    paddingValueDisplay.textContent = state.padding || '180';

                    // 3. 应用布局
                    const layoutRadio = document.getElementById(state.layout || 'template-grid-3x3');
                    if (layoutRadio) layoutRadio.checked = true;

                    // 4. 异步加载所有图片
                    const imageLoadPromises = [];
                    if (state.images) {
                        for (let i = 1; i <= 9; i++) {
                            const url = state.images[i];
                            if (url) {
                                // 4a. 恢复状态
                                sourceUrls[i] = url;
                                // 4b. 更新 UI 预览
                                const previewImg = document.getElementById(`preview-${i}`);
                                if (previewImg) {
                                    previewImg.src = url;
                                    previewImg.classList.remove('hidden');
                                }
                                // 4c. 加载图片到画布
                                imageLoadPromises.push(loadImage(url, i));
                            }
                        }
                    }

                    // 5. 等待所有图片加载（或失败）
                    await Promise.allSettled(imageLoadPromises);

                    showNeteaseMessage('配置加载完毕!', 'success');
                    setTimeout(() => showNeteaseMessage('', 'hidden'), 2000);

                } catch (e) {
                    console.error("从 URL 加载状态失败:", e);
                    showNeteaseMessage('链接解析失败!', 'error');
                } finally {
                    // 无论成功与否，最后都重绘一次
                    drawPoster();
                }
            }

            // --- 初始化 ---
            populateSlotSelector();
            // [V10] 启动时从 URL 加载状态，而不是直接绘制
            loadStateFromUrl();


            // --- [V10] 更新事件监听器，加入 updateUrl() ---
            [textTitle, textSharer, bgColorInput, paddingInput].forEach(el => {
                el.addEventListener('input', () => {
                    drawPoster();
                    updateUrl();
                });
            });
            templateRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    drawPoster();
                    updateUrl();
                });
            });
            paddingInput.addEventListener('input', () => {
                paddingValueDisplay.textContent = paddingInput.value;
            });
            uploadInputs.forEach(input => {
                input.addEventListener('change', (e) => handleFileChange(e, input.dataset.slot));
            });
            clearBtn.addEventListener('click', clearAll);
            downloadBtn.addEventListener('click', downloadPoster);

            neteaseFetchBtn.addEventListener('click', handleNeteaseFetch);
            neteaseUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleNeteaseFetch();
            });


            // --- 核心函数 ---

            function populateSlotSelector() {
                for (let i = 1; i <= 9; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `到插槽 ${i}`;
                    neteaseSlotSelect.appendChild(option);
                }
            }

            /**
             * [V8] 代理 + OG:Image 提取逻辑
             */
            async function handleNeteaseFetch() {
                const rawInput = neteaseUrlInput.value.trim();
                const targetSlot = neteaseSlotSelect.value;
                if (!rawInput) {
                    showNeteaseMessage('请输入分享文本或URL', 'error');
                    return;
                }
                setNeteaseLoading(true);
                showNeteaseMessage('正在识别链接...', 'loading');

                try {
                    const urlRegex = /(https?:\/\/[^\s"'()]+)/;
                    const match = rawInput.match(urlRegex);
                    if (!match) throw new Error('未在输入内容中找到有效的URL。');

                    let songUrl = match[0].replace("/#/", "/");
                    showNeteaseMessage('识别到URL, 正在解析...', 'loading');

                    const proxyUrl = `${CORS_PROXY_URL}${encodeURIComponent(songUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`网络错误 (代理): ${response.status}`);

                    const html = await response.text();
                    showNeteaseMessage('解析HTML, 查找封面...', 'loading');

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const ogImageTag = doc.querySelector("meta[property='og:image']");
                    if (!ogImageTag) throw new Error('无法在此页面找到封面图片(og:image)。');

                    let imageUrl = ogImageTag.getAttribute('content');
                    if (!imageUrl) throw new Error('找到了图片标签(og:image)，但内容为空。');

                    const baseUrl = imageUrl.split('?')[0];
                    const hdUrl = `${baseUrl}?param=3000y3000`;

                    // [V10] 存储可分享的 URL
                    sourceUrls[targetSlot] = hdUrl;

                    const previewImg = document.getElementById(`preview-${targetSlot}`);
                    if (previewImg) {
                        previewImg.src = hdUrl;
                        previewImg.classList.remove('hidden');
                    }
                    const fileInput = document.getElementById(`upload-${targetSlot}`);
                    if (fileInput) fileInput.value = null;

                    await loadImage(hdUrl, targetSlot);

                    // [V10] 重绘并更新 URL
                    drawPoster();
                    updateUrl();

                    showNeteaseMessage(`成功提取到插槽 ${targetSlot}！`, 'success');
                    neteaseUrlInput.value = '';

                } catch (err) {
                    console.error("提取失败:", err);
                    showNeteaseMessage(err.message || '提取失败，请重试。', 'error');
                    // [V10] 提取失败，清除源
                    sourceUrls[targetSlot] = null;
                } finally {
                    setNeteaseLoading(false);
                }
            }


            function setNeteaseLoading(isLoading) {
                if (isLoading) {
                    neteaseFetchBtn.disabled = true;
                    neteaseBtnText.classList.add('hidden');
                    neteaseLoader.classList.remove('hidden');
                } else {
                    neteaseFetchBtn.disabled = false;
                    neteaseBtnText.classList.remove('hidden');
                    neteaseLoader.classList.add('hidden');
                }
            }

            function showNeteaseMessage(message, type = 'loading') {
                if (type === 'hidden') {
                    neteaseMsg.classList.add('hidden');
                    return;
                }
                neteaseMsg.textContent = message;
                neteaseMsg.classList.remove('hidden', 'text-gray-500', 'text-green-600', 'text-red-500');
                if (type === 'error') neteaseMsg.classList.add('text-red-500');
                else if (type === 'success') neteaseMsg.classList.add('text-green-600');
                else neteaseMsg.classList.add('text-gray-500');
            }

            /**
             * 处理文件上传
             */
            function handleFileChange(event, slot) {
                showNeteaseMessage('', 'hidden');

                // [V10] 本地上传的图片无法分享，清除 sourceUrl
                sourceUrls[slot] = null;

                const file = event.target.files[0];
                if (!file) {
                    loadedImages[slot] = null;
                    const previewImg = document.getElementById(`preview-${slot}`);
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.classList.add('hidden');
                    }
                    drawPoster();
                    updateUrl(); // [V10] 移除了图片，也更新 URL
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataURL = e.target.result;
                    const previewImg = document.getElementById(`preview-${slot}`);
                    if (previewImg) {
                        previewImg.src = dataURL;
                        previewImg.classList.remove('hidden');
                    }
                    // [V10] dataURL 不存入 sourceUrls
                    loadImage(dataURL, slot).then(() => {
                        drawPoster();
                        updateUrl(); // [V10] 添加了图片，更新 URL (虽然这张图不会被分享)
                    });
                };
                reader.readAsDataURL(file);
            }

            /**
             * 异步加载图像
             */
            function loadImage(src, slot) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        loadedImages[slot] = img;
                        resolve(img); // [V1D] 成功时只 resolve
                    };
                    img.onerror = (err) => {
                        console.error(`Failed to load image for slot ${slot}:`, src, err);
                        loadedImages[slot] = null;
                        // [V10] 即使加载失败也清除源 URL，并重绘
                        sourceUrls[slot] = null;
                        drawPoster();
                        updateUrl();
                        reject(err); // [V10] 失败时 reject
                    };
                    img.src = src;
                });
            }

            /**
             * 主绘制函数
             */
            function drawPoster() {
                const settings = {
                    title: textTitle.value || "顔色推歌",
                    sharer: textSharer.value || "填表人：",
                    template: document.querySelector('input[name="template"]:checked').value,
                    bgColor: bgColorInput.value || '#F4F4F8',
                    padding: parseInt(paddingInput.value, 10) || 180,
                };
                const activeImages = [];
                for (let i = 1; i <= 9; i++) {
                    if (loadedImages[i]) {
                        activeImages.push(loadedImages[i]);
                    }
                }
                drawBackground(settings.bgColor, activeImages.length === 0);
                const TOP_TEXT_ZONE_HEIGHT = 450;
                const BOTTOM_TEXT_ZONE_HEIGHT = 300;
                const contentBox = {
                    x: settings.padding,
                    y: settings.padding + TOP_TEXT_ZONE_HEIGHT,
                    width: CANVAS_SIZE - settings.padding * 2,
                    height: CANVAS_SIZE - (settings.padding * 2) - TOP_TEXT_ZONE_HEIGHT - BOTTOM_TEXT_ZONE_HEIGHT
                };
                switch (settings.template) {
                    case 'hero': drawHeroLayout(activeImages, contentBox); break;
                    case 'grid-2x2': drawGrid2x2Layout(activeImages, contentBox); break;
                    case 'grid-3x3': drawGrid3x3Layout(activeImages, contentBox); break;
                }
                drawText(settings);
            }

            function drawBackground(color, showHint) {
                ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                if (showHint) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '90px "STDongGuanTi", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('请在左侧上传或提取专辑封面', CANVAS_SIZE / 2, CANVAS_SIZE / 2);
                }
            }

            /**
             * [V9] 辅助: 绘制文本 (使用新字体和新尺寸)
             */
            function drawText(settings) {
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                const padding = settings.padding;
                const TOP_TEXT_ZONE_HEIGHT = 450;
                const BOTTOM_TEXT_ZONE_HEIGHT = 300;

                // 标题
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 156px "STDongGuanTi", "Noto Serif SC", serif';
                ctx.textAlign = 'center';
                const titleY = padding + (TOP_TEXT_ZONE_HEIGHT / 2) + 45;
                ctx.fillText(settings.title, CANVAS_SIZE / 2, titleY);

                // 分享人
                ctx.font = 'normal 84px "Zhuque Fangsong (technical preview)", "Noto Sans SC", sans-serif';
                ctx.fillStyle = '#555555';
                ctx.textAlign = 'center';
                const sharerY = (CANVAS_SIZE - padding - BOTTOM_TEXT_ZONE_HEIGHT) + (BOTTOM_TEXT_ZONE_HEIGHT / 2) + 30;
                ctx.fillText(settings.sharer, CANVAS_SIZE / 2, sharerY);
            }

            // --- 布局绘制函数 (V9 缩放版) ---

            function drawHeroLayout(images, box) {
                const gap = 60;
                if (!images[0]) return;
                const heroSize = box.height;
                const smallSize = (box.height - gap) / 2;
                const totalWidth = heroSize + gap + smallSize;
                const startX = box.x + (box.width - totalWidth) / 2;
                drawSquareCover(images[0], startX, box.y, heroSize);
                if (images[1]) drawSquareCover(images[1], startX + heroSize + gap, box.y, smallSize);
                if (images[2]) drawSquareCover(images[2], startX + heroSize + gap, box.y + smallSize + gap, smallSize);
            }

            function drawGrid2x2Layout(images, box) {
                const gap = 60;
                let size = (box.width - gap) / 2;
                if (size * 2 + gap > box.height) size = (box.height - gap) / 2;
                const startX = box.x + (box.width - (size * 2 + gap)) / 2;
                const startY = box.y + (box.height - (size * 2 + gap)) / 2;
                if (images[0]) drawSquareCover(images[0], startX, startY, size);
                if (images[1]) drawSquareCover(images[1], startX + size + gap, startY, size);
                if (images[2]) drawSquareCover(images[2], startX, startY + size + gap, size);
                if (images[3]) drawSquareCover(images[3], startX + size + gap, startY + size + gap, size);
            }

            function drawGrid3x3Layout(images, box) {
                const gap = 60;
                let size = (box.width - gap * 2) / 3;
                if (size * 3 + gap * 2 > box.height) size = (box.height - gap * 2) / 3;
                const totalWidth = size * 3 + gap * 2;
                const totalHeight = size * 3 + gap * 2;
                const startX = box.x + (box.width - totalWidth) / 2;
                const startY = box.y + (box.height - totalHeight) / 2;
                for (let i = 0; i < 9; i++) {
                    if (images[i]) {
                        const row = Math.floor(i / 3);
                        const col = i % 3;
                        const x = startX + col * (size + gap);
                        const y = startY + row * (size + gap);
                        drawSquareCover(images[i], x, y, size);
                    }
                }
            }

            function drawSquareCover(img, dx, dy, dSize) {
                if (!img || !img.width || !img.height) return;
                const sMin = Math.min(img.width, img.height);
                const sx = (img.width - sMin) / 2;
                const sy = (img.height - sMin) / 2;
                const cornerRadius = 24;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(dx + cornerRadius, dy);
                ctx.lineTo(dx + dSize - cornerRadius, dy);
                ctx.quadraticCurveTo(dx + dSize, dy, dx + dSize, dy + cornerRadius);
                ctx.lineTo(dx + dSize, dy + dSize - cornerRadius);
                ctx.quadraticCurveTo(dx + dSize, dy + dSize, dx + dSize - cornerRadius, dy + dSize);
                ctx.lineTo(dx + cornerRadius, dy + dSize);
                ctx.quadraticCurveTo(dx, dy + dSize, dx, dy + dSize - cornerRadius);
                ctx.lineTo(dx, dy + cornerRadius);
                ctx.quadraticCurveTo(dx, dy, dx + cornerRadius, dy);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(img, sx, sy, sMin, sMin, dx, dy, dSize, dSize);
                ctx.restore();
            }

            /**
             * 清空所有
             */
            function clearAll() {
                // [V10] 重置所有状态
                sourceUrls = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null };
                loadedImages = {};

                uploadInputs.forEach((input, index) => {
                    input.value = null;
                    const previewImg = document.getElementById(`preview-${index + 1}`);
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.classList.add('hidden');
                    }
                });

                textTitle.value = '';
                textSharer.value = '';
                bgColorInput.value = '#F4F4F8';
                paddingInput.value = '180';
                paddingValueDisplay.textContent = '180';
                document.getElementById('template-grid-3x3').checked = true;

                neteaseUrlInput.value = '';
                neteaseSlotSelect.value = '1';
                showNeteaseMessage('', 'hidden');

                drawPoster();

                // [V10] 清空 URL
                window.history.pushState({}, '', window.location.pathname);
            }

            function downloadPoster() {
                try {
                    const link = document.createElement('a');
                    link.download = `${textTitle.value || 'music-poster'}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    console.error("下载失败:", e);
                    showNeteaseMessage('下载失败 (可能CORS错误)', 'error');
                }
            }
        });
    </script>

</body>

</html>