<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专辑封面拼图海报生成器</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字体 */
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }

        /* 隐藏文件输入的默认按钮 */
        input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* 预览图的容器 */
        .slot-preview {
            position: relative;
            aspect-ratio: 1 / 1;
            border: 2px dashed #4B5563;
            /* dark:border-gray-700 -> border-gray-600 */
            background-color: #1F2937;
            /* dark:bg-gray-800 -> bg-gray-900 */
            color: #9CA3AF;
            /* dark:text-gray-400 -> text-gray-500 */
            transition: all 0.2s ease-in-out;
        }

        .slot-preview:hover {
            border-color: #EF4444;
            /* red-500 */
            color: #F9FAFB;
            /* dark:text-gray-100 -> text-gray-200 */
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 标题 -->
        <header class="text-center mb-8">
            <h1
                class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-red-700">
                专辑封面拼图海报生成器
            </h1>
            <p class="text-gray-400 mt-2">
                上传 1-4 张专辑封面，创作你的专属音乐海报
            </p>
        </header>

        <!-- 主内容区：左侧控制 + 右侧预览 -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 左侧：控制面板 -->
            <div class="flex flex-col gap-6 p-6 bg-gray-800 rounded-xl shadow-lg">
                <!-- 1. 上传区域 -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">1. 上传封面</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- 插槽 1 -->
                        <div id="slot-container-1"
                            class="slot-preview rounded-lg flex items-center justify-center text-center p-4">
                            <img id="preview-1"
                                class="absolute inset-0 w-full h-full object-cover rounded-lg z-10 hidden" alt="预览1">
                            <div class="flex flex-col items-center z-0">
                                <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span class="text-sm">插槽 1</span>
                            </div>
                            <input type="file" accept="image/*" id="upload-1" data-slot="1">
                        </div>
                        <!-- 插槽 2 -->
                        <div id="slot-container-2"
                            class="slot-preview rounded-lg flex items-center justify-center text-center p-4">
                            <img id="preview-2"
                                class="absolute inset-0 w-full h-full object-cover rounded-lg z-10 hidden" alt="预览2">
                            <div class="flex flex-col items-center z-0">
                                <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span class="text-sm">插槽 2</span>
                            </div>
                            <input type="file" accept="image/*" id="upload-2" data-slot="2">
                        </div>
                        <!-- 插槽 3 -->
                        <div id="slot-container-3"
                            class="slot-preview rounded-lg flex items-center justify-center text-center p-4">
                            <img id="preview-3"
                                class="absolute inset-0 w-full h-full object-cover rounded-lg z-10 hidden" alt="预览3">
                            <div class="flex flex-col items-center z-0">
                                <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span class="text-sm">插槽 3</span>
                            </div>
                            <input type="file" accept="image/*" id="upload-3" data-slot="3">
                        </div>
                        <!-- 插槽 4 -->
                        <div id="slot-container-4"
                            class="slot-preview rounded-lg flex items-center justify-center text-center p-4">
                            <img id="preview-4"
                                class="absolute inset-0 w-full h-full object-cover rounded-lg z-10 hidden" alt="预览4">
                            <div class="flex flex-col items-center z-0">
                                <svg class="w-10 h-10 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span class="text-sm">插槽 4</span>
                            </div>
                            <input type="file" accept="image/*" id="upload-4" data-slot="4">
                        </div>
                    </div>
                </div>

                <!-- 2. 自定义选项 -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">2. 自定义海报</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- 背景色 -->
                        <div class="flex flex-col">
                            <label for="bg-color" class="mb-2 text-sm font-medium text-gray-300">背景颜色</label>
                            <div class="relative">
                                <input id="bg-color" type="color" value="#111827"
                                    class="p-2 h-10 w-full rounded-md border-gray-700 bg-gray-900 cursor-pointer appearance-none border-none">
                            </div>
                        </div>
                        <!-- 间距 -->
                        <div class="flex flex-col">
                            <label for="gap-size" class="mb-2 text-sm font-medium text-gray-300">封面间距 (px)</label>
                            <input id="gap-size" type="number" value="20" min="0" max="100"
                                class="h-10 p-2 w-full rounded-md border-gray-700 bg-gray-900 text-white focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                </div>

                <!-- 3. 操作按钮 -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">3. 生成与下载</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clear-btn"
                            class="w-full py-3 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors shadow-md">
                            清空全部
                        </button>
                        <button id="download-btn"
                            class="w-full py-3 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors shadow-lg shadow-red-600/30">
                            下载海报
                        </button>
                    </div>
                </div>

            </div>

            <!-- 右侧：画布预览 -->
            <div class="flex flex-col items-center">
                <h2 class="text-xl font-semibold mb-4 text-center">海报预览</h2>
                <!-- 画布容器，用于保持宽高比 -->
                <div class="w-full max-w-lg aspect-square bg-gray-800 rounded-xl shadow-lg p-2">
                    <canvas id="poster-canvas" width="1000" height="1000" class="w-full h-full rounded-lg"></canvas>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 画布和上下文
            const canvas = document.getElementById('poster-canvas');
            const ctx = canvas.getContext('2d');
            const CANVAS_SIZE = 1000; // 画布基础尺寸
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // DOM 元素
            const uploadInputs = [
                document.getElementById('upload-1'),
                document.getElementById('upload-2'),
                document.getElementById('upload-3'),
                document.getElementById('upload-4'),
            ];
            const previewImages = [
                document.getElementById('preview-1'),
                document.getElementById('preview-2'),
                document.getElementById('preview-3'),
                document.getElementById('preview-4'),
            ];
            const bgColorInput = document.getElementById('bg-color');
            const gapSizeInput = document.getElementById('gap-size');
            const clearBtn = document.getElementById('clear-btn');
            const downloadBtn = document.getElementById('download-btn');

            // 存储图像数据
            let imageSlots = { 1: null, 2: null, 3: null, 4: null };

            // 初始化画布
            drawPoster();

            // --- 事件监听 ---

            // 监听所有文件上传
            uploadInputs.forEach((input, index) => {
                input.addEventListener('change', (e) => handleFileChange(e, input.dataset.slot));
            });

            // 监听自定义选项
            bgColorInput.addEventListener('input', drawPoster);
            gapSizeInput.addEventListener('input', drawPoster);

            // 监听按钮
            clearBtn.addEventListener('click', clearAll);
            downloadBtn.addEventListener('click', downloadPoster);

            // --- 核心功能函数 ---

            /**
             * 处理文件上传
             */
            function handleFileChange(event, slot) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataURL = e.target.result;
                    imageSlots[slot] = dataURL;

                    // 更新预览图
                    const previewImg = document.getElementById(`preview-${slot}`);
                    previewImg.src = dataURL;
                    previewImg.classList.remove('hidden');

                    // 重新绘制画布
                    drawPoster();
                };
                reader.readAsDataURL(file);
            }

            /**
             * 绘制海报
             */
            async function drawPoster() {
                const GAP = parseInt(gapSizeInput.value, 10) || 0;
                const BG_COLOR = bgColorInput.value || '#111827';

                // 1. 绘制背景
                ctx.fillStyle = BG_COLOR;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // 2. 准备加载图像
                const imagesToLoad = [];
                for (const slot in imageSlots) {
                    if (imageSlots[slot]) {
                        imagesToLoad.push(loadImage(imageSlots[slot], slot));
                    }
                }

                if (imagesToLoad.length === 0) {
                    // 没有图片，绘制提示文字
                    ctx.fillStyle = '#6B7280';
                    ctx.font = '30px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText('请在左侧上传专辑封面', CANVAS_SIZE / 2, CANVAS_SIZE / 2);
                    return;
                }

                const loadedImages = await Promise.all(imagesToLoad);

                // 3. 计算布局
                // 我们使用一个 2x2 网格布局
                const imgSize = (CANVAS_SIZE - GAP * 3) / 2; // 每张图的尺寸
                const pos1 = GAP;
                const pos2 = GAP * 2 + imgSize;

                const positions = {
                    1: { x: pos1, y: pos1, w: imgSize, h: imgSize },
                    2: { x: pos2, y: pos1, w: imgSize, h: imgSize },
                    3: { x: pos1, y: pos2, w: imgSize, h: imgSize },
                    4: { x: pos2, y: pos2, w: imgSize, h: imgSize },
                };

                // 4. 绘制图像
                loadedImages.forEach(({ img, slot }) => {
                    const pos = positions[slot];
                    if (pos) {
                        drawCoverImage(img, pos.x, pos.y, pos.w, pos.h);
                    }
                });
            }

            /**
             * 加载图像
             * @param {string} src - 图像的 dataURL
             * @param {string} slot - 插槽编号
             * @returns {Promise<{img: HTMLImageElement, slot: string}>}
             */
            function loadImage(src, slot) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve({ img, slot });
                    img.onerror = (err) => reject(err);
                    img.src = src;
                });
            }

            /**
             * 以 "object-fit: cover" 的方式绘制图像
             * (裁剪图像以填充目标矩形)
             */
            function drawCoverImage(img, dx, dy, dWidth, dHeight) {
                const sWidth = img.width;
                const sHeight = img.height;
                const sRatio = sWidth / sHeight;
                const dRatio = dWidth / dHeight;

                let sx = 0, sy = 0, sw = sWidth, sh = sHeight;

                if (sRatio > dRatio) {
                    // 图像比目标框更宽
                    sw = sHeight * dRatio;
                    sx = (sWidth - sw) / 2;
                } else {
                    // 图像比目标框更高
                    sh = sWidth / dRatio;
                    sy = (sHeight - sh) / 2;
                }

                ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dWidth, dHeight);
            }

            /**
             * 清空所有
             */
            function clearAll() {
                // 重置数据
                imageSlots = { 1: null, 2: null, 3: null, 4: null };

                // 清空预览图
                previewImages.forEach((img) => {
                    img.src = '';
                    img.classList.add('hidden');
                });

                // 重置文件输入框 (通过重置表单或父元素实现，这里用简单方法)
                uploadInputs.forEach((input) => {
                    input.value = null; // 这不总有效，但对change事件足够
                });

                // 重置自定义选项
                bgColorInput.value = '#111827';
                gapSizeInput.value = '20';

                // 重新绘制画布
                drawPoster();
            }

            /**
             * 下载海报
             */
            function downloadPoster() {
                const link = document.createElement('a');
                link.download = 'album-poster.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        });
    </script>

</body>

</html>